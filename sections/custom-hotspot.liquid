{% comment %}
  Hotspots Product Map + Panel + Modal Product
{% endcomment %}

<section class="hs color-{{ section.settings.color_scheme }} section-{{ section.id }}-padding" data-hs-root>
  <div class="page-width">
    {% if section.settings.sec_title != blank %}
      <h2 class="hs__title">{{ section.settings.sec_title }}</h2>
    {% endif %}
    {% if section.settings.sec_text != blank %}
      <div class="hs__text">{{ section.settings.sec_text }}</div>
    {% endif %}
  </div>

  <div class="custom-width">
    <div class="hs__canvas">
      <div class="hs__media">
        {%- assign desktop_image = section.settings.main_image -%}
        {%- assign mobile_image = section.settings.main_image_mobile | default: desktop_image -%}

        {% if desktop_image != blank or mobile_image != blank %}
          {%- if desktop_image != blank -%}
            {{ desktop_image
              | image_url: width: 2400
              | image_tag:
                class: 'hs__img hs__img--desktop',
                sizes: '100vw',
                widths: '750,1100,1500,2000,2400',
                alt: section.settings.alt_text | default: section.settings.sec_title | escape
            }}
          {%- endif -%}

          {%- if mobile_image != blank -%}
            {{ mobile_image
              | image_url: width: 1600
              | image_tag:
                class: 'hs__img hs__img--mobile',
                sizes: '100vw',
                widths: '750,1100,1500',
                alt: section.settings.alt_text | default: section.settings.sec_title | escape
            }}
          {%- endif -%}
        {% else %}
          <div class="hs__placeholder">
            {{ 'hero-apparel-3' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
      </div>

      {%- comment -%} HOTSPOTS (cada punto lleva todos los datos del producto en data-*) {%- endcomment -%}
      {%- for block in section.blocks -%}
        {%- assign b = block.settings -%}
        {%- assign p = b.product_ref -%}

        {%- if p != blank -%}
          {%- assign v       = p.selected_or_first_available_variant -%}
          {%- assign price   = v.price | default: p.price -%}
          {%- assign compare = v.compare_at_price | default: p.compare_at_price -%}
          {%- assign url     = b.view_url | default: p.url -%}
          {%- assign main_img = b.card_image | default: p.featured_image -%}
          {%- assign thumb    = p.featured_image | default: b.card_image -%}
        {%- else -%}
          {%- assign v       = blank -%}
          {%- assign price   = blank -%}
          {%- assign compare = blank -%}
          {%- assign url     = b.view_url -%}
          {%- assign main_img = b.card_image -%}
          {%- assign thumb    = b.card_image -%}
        {%- endif -%}

        <button
          class="hs-point{% if b.pulse %} hs-point--pulse{% endif %}"
          type="button"
          aria-label="{{ b.hotspot_label | default: 'View product' }}"
          style="top:{{ b.top_position }}%; left:{{ b.left_position }}%;"
          data-title="{{ b.title_override | default: p.title | default: 'Product' | escape }}"
          data-price="{% if price != blank %}{{ price | money | strip_html | escape }}{% endif %}"
          data-compare="{% if compare != blank and compare > price %}{{ compare | money | strip_html | escape }}{% endif %}"
          data-url="{{ url }}"
          data-thumb="{% if thumb != blank %}{{ thumb | image_url: width: 260 }}{% endif %}"
          data-main="{% if main_img != blank %}{{ main_img | image_url: width: 1200 }}{% endif %}"
          data-vid="{% if v != blank %}{{ v.id }}{% endif %}"
          data-qty="{{ b.qty | default: 1 }}"
          data-desc="{% if p.description != blank %}{{ p.description | strip_html | escape }}{% else %}{{ b.card_text | strip_html | escape }}{% endif %}"
        >
          {% if b.point_icon != blank %}
            {{ b.point_icon | image_url: width: 44 | image_tag: class: 'hs-point__icon', alt: '' }}
          {% else %}
            <span class="hs-point__dot"></span>
          {% endif %}
        </button>
      {%- endfor -%}

      {%- comment -%} PANEL MINI (abajo izquierda) {%- endcomment -%}
      <aside class="hs-panel" data-hs-panel aria-hidden="true">
        <div class="hs-panel__inner">
          <button class="hs-panel__close" type="button" aria-label="Close">X</button>

          <div class="hs-panel__main">
            <div class="hs-panel__thumb-wrap">
              <img class="hs-panel__thumb" src="" alt="">
            </div>

            <div class="hs-panel__meta">
              <h3 class="hs-panel__title" data-hs-panel-title>Product title</h3>
              <div class="hs-panel__prices" data-hs-panel-prices>
                <span class="hs-panel__compare" data-hs-panel-compare></span>
                <span class="hs-panel__price" data-hs-panel-price></span>
              </div>
              <button
                class="hs-btn hs-btn--ghost hs-panel__view view-product"
                type="button"
                data-hs-panel-view
              >
                VIEW PRODUCT
              </button>
              <button
                class="hs-btn hs-btn--ghost hs-panel__add js-hs-add"
                type="button"
                data-hs-panel-add
              >
                ADD TO CART
              </button>
            </div>
          </div>

          <div class="hs-panel__nav">
            <button class="hs-panel__arrow hs-panel__arrow--prev" type="button" aria-label="Previous" data-hs-panel-prev>
              <div class="hs-panel-icon">
                {{- 'single-left-arrow-icon.svg' | inline_asset_content -}}
              </div> 
            </button>
            <button class="hs-panel__arrow hs-panel__arrow--next" type="button" aria-label="Next" data-hs-panel-next>
              <div class="hs-panel-icon">
                {{- 'single-right-arrow-icon.svg' | inline_asset_content -}}
              </div>            
            </button>
          </div>
        </div>
      </aside>
    </div>
  </div>

{%- comment -%} MODAL GRANDE PRODUCTO {%- endcomment -%}
<div class="hs-modal" data-hs-modal aria-hidden="true">
  <div class="hs-modal__backdrop"></div>

  <div class="hs-modal__dialog" role="dialog" aria-modal="true">
    <div class="hs-modal__content">
      <button class="hs-modal__close" type="button" aria-label="Close">×</button>

      <div class="hs-modal__image">
        <img class="popup-logo" src="{{ 'popup-logo.png' | asset_url }}" alt="arrow" height="60" width="60" />
        <img class="hs-modal__img" src="" alt="popup cover" height="100%" width="100%">
      </div>
      <div class="hs-modal__info">
        <h3 class="hs-modal__title" data-hs-modal-title>Product title…</h3>

        <div class="hs-modal__prices" data-hs-modal-prices>
          <span class="hs-modal__compare" data-hs-modal-compare></span>
          <span class="hs-modal__price" data-hs-modal-price></span>
        </div>

        <div class="hs-modal__desc" data-hs-modal-desc></div>

        <div class="hs-modal__actions">
          <button
            class="hs-btn hs-btn--solid hs-modal__add js-hs-add modal-atc-btn"
            type="button"
            data-hs-modal-add
          >
          <span class="svg-wrapper iconbag">{{ 'icon-shopping.bag.svg' | inline_asset_content }}</span>
            ADD TO CART
          </button>
          <a
            href="#"
            class="hs-btn hs-btn--solid hs-modal__link learnmore"
            data-hs-modal-link
          >
            LEARN MORE
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .section-{{ section.id }}-padding{
    padding-top:{{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom:{{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px
  }
  @media(min-width:750px){
    .section-{{ section.id }}-padding{
      padding-top:{{ section.settings.padding_top }}px;
      padding-bottom:{{ section.settings.padding_bottom }}px
    }
  }
</style>

{{ 'custom-hotspot.css' | asset_url | stylesheet_tag }}

  <script>
    (function(){
      function init(root){
        if(!root || root.dataset.hsInited === '1') return;
        root.dataset.hsInited = '1';

        const points = root.querySelectorAll('.hs-point');
        if(!points.length) return;

        const canvas = root.querySelector('.hs__canvas');

        /* Panel */
        const panel        = root.querySelector('[data-hs-panel]');
        const panelTitle   = panel.querySelector('[data-hs-panel-title]');
        const panelPrice   = panel.querySelector('[data-hs-panel-price]');
        const panelCompare = panel.querySelector('[data-hs-panel-compare]');
        const panelPrices  = panel.querySelector('[data-hs-panel-prices]');
        const panelThumb   = panel.querySelector('.hs-panel__thumb');
        const panelViewBtn = panel.querySelector('[data-hs-panel-view]');
        const panelAddBtn  = panel.querySelector('[data-hs-panel-add]');
        const panelPrev    = panel.querySelector('[data-hs-panel-prev]');
        const panelNext    = panel.querySelector('[data-hs-panel-next]');
        const panelClose   = panel.querySelector('.hs-panel__close');

        /* Modal */
        const modal        = root.querySelector('[data-hs-modal]');
        const modalBackdrop = modal.querySelector('.hs-modal__backdrop');
        const modalClose   = modal.querySelector('.hs-modal__close');
        const modalImg     = modal.querySelector('.hs-modal__img');
        const modalTitle   = modal.querySelector('[data-hs-modal-title]');
        const modalPrice   = modal.querySelector('[data-hs-modal-price]');
        const modalCompare = modal.querySelector('[data-hs-modal-compare]');
        const modalPrices  = modal.querySelector('[data-hs-modal-prices]');
        const modalDesc    = modal.querySelector('[data-hs-modal-desc]');
        const modalLink    = modal.querySelector('[data-hs-modal-link]');
        const modalAddBtn  = modal.querySelector('[data-hs-modal-add]');

        let currentIndex = -1;

        function getDataFromPoint(point){
          const d = point.dataset;
          return {
            title: d.title || '',
            price: d.price || '',
            compare: d.compare || '',
            url: d.url || '',
            thumb: d.thumb || '',
            main: d.main || d.thumb || '',
            vid: d.vid || '',
            qty: d.qty || '1',
            desc: d.desc || ''
          };
        }

        function renderPanel(index){
          if(!points.length) return;
          currentIndex = (index + points.length) % points.length;
          const point = points[currentIndex];
          const data = getDataFromPoint(point);

          points.forEach((p,i)=> p.classList.toggle('is-active', i === currentIndex));

          if(data.thumb){
            panelThumb.src = data.thumb;
            panelThumb.style.display = '';
          }else{
            panelThumb.removeAttribute('src');
            panelThumb.style.display = 'none';
          }

          panelTitle.textContent = data.title || '';

          if(data.price){
            panelPrice.textContent = data.price;
            panelPrices.style.display = '';
          }else{
            panelPrices.style.display = 'none';
          }
          if(data.compare){
            panelCompare.textContent = data.compare;
            panelCompare.style.display = '';
          }else{
            panelCompare.textContent = '';
            panelCompare.style.display = 'none';
          }

          if(data.url){
            panelViewBtn.style.display = '';
          }else{
            panelViewBtn.style.display = 'none';
          }

          if(data.vid){
            panelAddBtn.style.display = '';
            panelAddBtn.dataset.vid = data.vid;
            panelAddBtn.dataset.qty = data.qty || '1';
          }else{
            panelAddBtn.style.display = 'none';
            delete panelAddBtn.dataset.vid;
            delete panelAddBtn.dataset.qty;
          }

          panel.classList.add('is-open');
          panel.setAttribute('aria-hidden','false');
          root.classList.add('hs--panel-open');
        }

        function closePanel(){
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden','true');
          root.classList.remove('hs--panel-open');
          points.forEach(p => p.classList.remove('is-active'));
          currentIndex = -1;

          if (modal.classList.contains('is-open')) {
            closeModal(false); 
          }
        }


        function openModalFromCurrent(){
          if(currentIndex < 0) return;
          const point = points[currentIndex];
          const data = getDataFromPoint(point);

          if(data.main){
            modalImg.src = data.main;
            modalImg.style.display = '';
          }else{
            modalImg.removeAttribute('src');
            modalImg.style.display = 'none';
          }

          modalTitle.textContent = data.title || '';

          if(data.price){
            modalPrice.textContent = data.price;
            modalPrices.style.display = '';
          }else{
            modalPrices.style.display = 'none';
          }
          if(data.compare){
            modalCompare.textContent = data.compare;
            modalCompare.style.display = '';
          }else{
            modalCompare.textContent = '';
            modalCompare.style.display = 'none';
          }

          if(data.desc){
            modalDesc.innerHTML = data.desc.replace(/\n/g, '<br>');
            modalDesc.style.display = '';
          }else{
            modalDesc.innerHTML = '';
            modalDesc.style.display = 'none';
          }


          if(data.url){
            modalLink.href = data.url;
            modalLink.style.display = '';
          }else{
            modalLink.removeAttribute('href');
            modalLink.style.display = 'none';
          }

          if(data.vid){
            modalAddBtn.style.display = '';
            modalAddBtn.dataset.vid = data.vid;
            modalAddBtn.dataset.qty = data.qty || '1';
          }else{
            modalAddBtn.style.display = 'none';
            delete modalAddBtn.dataset.vid;
            delete modalAddBtn.dataset.qty;
          }

          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden','false');
          document.documentElement.classList.add('hs-modal-open');
        }

        function closeModal(alsoClosePanel = true){
          modal.classList.remove('is-open');
          modal.setAttribute('aria-hidden','true');
          document.documentElement.classList.remove('hs-modal-open');

          if (modalImg) modalImg.removeAttribute('src');

          {% comment %} if (alsoClosePanel && panel.classList.contains('is-open')) {
            panel.classList.remove('is-open');
            panel.setAttribute('aria-hidden','true');
            root.classList.remove('hs--panel-open');
            points.forEach(p => p.classList.remove('is-active'));
            currentIndex = -1;
          } {% endcomment %}
        }


        /*  hotspots */
        points.forEach((point, idx)=>{
          point.addEventListener('click', function(e){
            e.stopPropagation();
            renderPanel(idx);
          });
        });

        /* Panel events */
        function syncModalIfOpen(){
          if (modal.classList.contains('is-open')) {
            openModalFromCurrent();
          }
        }

        panelPrev.addEventListener('click', function(){
          if (!points.length) return;
          renderPanel(currentIndex - 1);
          syncModalIfOpen();
        });

        panelNext.addEventListener('click', function(){
          if (!points.length) return;
          renderPanel(currentIndex + 1);
          syncModalIfOpen();
        });

        panelClose.addEventListener('click', function(){
          closePanel();
        });
        panelViewBtn.addEventListener('click', function(){
          openModalFromCurrent();
        });

        canvas.addEventListener('click', function(e){
          if(e.target.closest('.hs-point') || e.target.closest('.hs-panel')) return;
          closePanel();
        });

        /* Modal events */
        modalClose.addEventListener('click', function(){
          closeModal();
        });
        modalBackdrop.addEventListener('click', function(){
          closeModal();
        });
        document.addEventListener('keydown', function(e){
          if(e.key === 'Escape' && modal.classList.contains('is-open')){
            closeModal();
          }
        });

        /* ADD TO CART – panel + modal (delegado) */
        root.addEventListener('click', function(e){
          const addBtn = e.target.closest('.js-hs-add');
          if(!addBtn) return;

          const vid = addBtn.dataset.vid;
          const qty = parseInt(addBtn.dataset.qty || '1', 10);
          if(!vid) return;

          addBtn.disabled = true;

          const sections = ['cart-notification-product', 'cart-notification-button', 'cart-icon-bubble'];
          const formData = new FormData();
          formData.append('id', vid);
          formData.append('quantity', qty);
          formData.append('sections', sections.join(','));
          formData.append('sections_url', window.location.pathname);

          const addUrl = (window.routes && window.routes.cart_add_url) ? window.routes.cart_add_url : '/cart/add';

          fetch(addUrl, { method:'POST', headers:{ 'Accept':'application/json' }, body: formData })
            .then(function(res){
              if(!res.ok) return res.json().then(function(err){ throw err; });
              return res.json();
            })
            .then(function(parsed){
              const cn = document.querySelector('cart-notification');
              if(cn && typeof cn.renderContents === 'function'){
                cn.renderContents(parsed);
              }else if(parsed.sections && parsed.sections['cart-icon-bubble']){
                const tmp = document.createElement('div');
                tmp.innerHTML = parsed.sections['cart-icon-bubble'];
                const newB = tmp.querySelector('#cart-icon-bubble');
                const curB = document.getElementById('cart-icon-bubble');
                if(newB && curB) curB.innerHTML = newB.innerHTML;
              }
            })
            .catch(function(err){
              console.error('Cart error:', err);
            })
            .finally(function(){
              setTimeout(function(){
                addBtn.disabled = false;
              }, 800);
            });
        });
      }

      function boot(){
        document.querySelectorAll('[data-hs-root]').forEach(init);
      }

      document.addEventListener('DOMContentLoaded', boot);
      document.addEventListener('shopify:section:load', boot);

      {% comment %} document.addEventListener('click', function(e){
        const closeBtn = e.target.closest('.hs-modal-close');
        if(!closeBtn) return;

        const modal = document.querySelector('[data-hs-modal]');
        if(modal){
          modal.classList.remove('is-open');
          document.documentElement.style.overflow = '';
        }
      }); {% endcomment %}


    })();
  </script>
</section>

{% schema %}
{
  "name": "Hotspots + Video Carousel",
  "class": "section-hotspots",
  "settings": [
    { "type": "text", "id": "sec_title", "label": "Título", "default": "Descubre la escena" },
    { "type": "richtext", "id": "sec_text", "label": "Texto", "default": "<p>Toca los puntos para ver los productos.</p>" },
    { "type": "image_picker", "id": "main_image", "label": "Imagen de fondo" },
    { "type": "image_picker", "id": "main_image_mobile", "label": "Imagen mobile" },
    { "type": "text", "id": "alt_text", "label": "Imagen producto" },

    { "type": "header", "content": "Overlay" },
    { "type": "color", "id": "overlay_color", "label": "Color de overlay", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Opacidad overlay", "min": 10, "max": 95, "step": 5, "unit": "%", "default": 80 },

    { "type": "color_scheme", "id": "color_scheme", "label": "Esquema de color", "default": "scheme-1" },
    { "type": "header", "content": "Espaciado" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding superior", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding inferior", "default": 40 }
  ],
  "blocks": [
    {
      "type": "point",
      "name": "Punto / Slide",
      "settings": [
        { "type": "text", "id": "hotspot_label", "label": "Etiqueta accesible", "default": "Ver producto" },
        { "type": "image_picker", "id": "point_icon", "label": "Ícono del punto (opcional)" },
        { "type": "checkbox", "id": "pulse", "label": "Animar pulso del punto", "default": true },

        { "type": "range", "id": "left_position", "label": "Posición izquierda (%)", "min": 0, "max": 100, "step": 1, "default": 50 },
        { "type": "range", "id": "top_position", "label": "Posición superior (%)", "min": 0, "max": 100, "step": 1, "default": 50 },

        { "type": "header", "content": "Medio del slide" },
        { "type": "select", "id": "media_type", "label": "Tipo de medio", "default": "image", "options": [
          { "value": "image", "label": "Imagen" },
          { "value": "video", "label": "Video" }
        ]},
        { "type": "image_picker", "id": "card_image", "label": "Imagen del slide" },

        { "type": "video", "id": "video_file", "label": "Video subido (MP4, mov)", "info": "Se prioriza sobre externo/URL." },
        { "type": "url", "id": "external_video", "label": "Video externo (YouTube/Vimeo)" },
        { "type": "url", "id": "video_mp4_url", "label": "URL MP4 directa (opcional)" },
        { "type": "checkbox", "id": "video_autoplay", "label": "Autoplay", "default": true },
        { "type": "checkbox", "id": "video_loop", "label": "Loop", "default": true },
        { "type": "checkbox", "id": "video_muted", "label": "Muted", "default": true },
        { "type": "checkbox", "id": "video_controls", "label": "Mostrar controles", "default": false },

        { "type": "header", "content": "Producto / Contenido" },
        { "type": "product", "id": "product_ref", "label": "Producto (recomendado)" },
        { "type": "text", "id": "title_override", "label": "Título alternativo" },
        { "type": "text", "id": "price_text", "label": "Precio (si no hay producto)" },
        { "type": "richtext", "id": "card_text", "label": "Descripción (opcional)", "default": "<p>Texto adicional</p>" },

        { "type": "url", "id": "view_url", "label": "URL Ver más (vacío: URL del producto)" },
        { "type": "checkbox", "id": "open_new", "label": "Abrir Ver más en nueva pestaña", "default": false },

        { "type": "header", "content": "Carrito" },
        { "type": "range", "id": "qty", "label": "Cantidad al agregar", "min": 1, "max": 10, "step": 1, "default": 1 },
        { "type": "text", "id": "label_view", "label": "Texto botón Ver más", "default": "Ver más" },
        { "type": "text", "id": "label_add", "label": "Texto botón Agregar", "default": "Agregar al carrito" }
      ]
    }
  ],
  "presets": [
    { "name": "Hotspots + Video carousel", "category": "Custom" }
  ],
  "max_blocks": 20
}
{% endschema %}

