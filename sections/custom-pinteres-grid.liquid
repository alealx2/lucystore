{% comment %}
Pinterest Grid 3+2 – OS 2.0 Section (Dawn compatible)
+ Optional actions per card (View More / Add to Cart)
+ Via Luci-style full-screen modal

- CSS and JS copied by #pgrid-{{ section.id }}
- Accessible modal (focus restore + ESC + backdrop)
- Pauses videos when closing the modal
- Robust add-to-cart fallback
{% endcomment %}

{% liquid
  assign ov_color   = section.settings.section_overlay_color | default: '#000000'
  assign ov_opacity = section.settings.section_overlay_opacity | default: 0 | divided_by: 100.0
  assign ov_rgba    = ov_color | color_modify: 'alpha', ov_opacity
%}

<section
  id="pgrid-{{ section.id }}"
  class="pgrid"
  style="
    z-index: 1;
    --gap: {{ section.settings.gap | default: 16 }}px;
    {% if section.settings.section_bg_type == 'image' and section.settings.section_bg_image != blank %}
      background-image: linear-gradient({{ ov_rgba }}, {{ ov_rgba }}),
                        url({{ section.settings.section_bg_image | image_url: width: 2400 }});
      background-size: cover;
      background-position: center center;
    {% else %}
      background-color: {{ section.settings.section_bg_color }};
      background-image: linear-gradient({{ ov_rgba }}, {{ ov_rgba }});
    {% endif %}
  "
>
  <div class="page-width">
    {% if section.settings.heading != blank or section.settings.subtext != blank %}
      <div class="pgrid__header pgrid__header--{{ section.settings.header_align }}">
        {% if section.settings.heading != blank %}
          <h2
            class="pgrid__title"
            style="
              color: {{ section.settings.heading_color }};
              font-size: {{ section.settings.heading_size }}px;
            "
          >
            {{ section.settings.heading }}
          </h2>
        {% endif %}
        {% if section.settings.subtext != blank %}
          <div
            class="pgrid__subtext"
            style="
              color: {{ section.settings.subtext_color }};
              font-size: {{ section.settings.subtext_size }}px;
            "
          >
            {{ section.settings.subtext }}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div class="page-width">
    <div class="pgrid__grid">
      {% for block in section.blocks %}
        {% assign b = block.settings %}

        {%- liquid
          assign link_url = blank
          if b.link_type == 'product' and b.product_ref != blank
            assign link_url = b.product_ref.url
          elsif b.link_type == 'custom' and b.link_url != blank
            assign link_url = b.link_url
          endif

          assign show_actions = false
          if b.actions_enable
            assign show_actions = true
          endif

          assign p = b.product_ref
          if p != blank
            assign v = p.selected_or_first_available_variant
            assign can_add = true
            if v == blank or v.available == false
              assign can_add = false
            endif
          endif

          assign download_href = b.download_url
          if download_href == blank and b.image != blank
            assign download_href = b.image | image_url: width: 2000
          endif
        -%}

        {%- capture card -%}
          <div
            class="pgrid__card color-{{ section.settings.color_scheme }}"
            data-card
            style="
              --h-desktop: {{ b.height_desktop }}px;
              --h-mobile: {{ b.height_mobile }}px;
              --overlay: {{ b.overlay_color }};
              --overlay-op: {{ b.overlay_opacity | times: 0.01 }};
              --radius: {{ b.radius }}px;
              --content-bg: {{ b.content_bg }};
            "
          >
            <div class="pgrid__media">
              {%- if block.settings.media_type == 'video' -%}
                {%- if block.settings.video_file != blank -%}
                  {{ block.settings.video_file | video_tag:
                      image_size: '800x',
                      class: 'grid-video-bg',
                      autoplay: b.video_autoplay,
                      loop: b.video_loop,
                      muted: b.video_muted,
                      controls: b.video_controls,
                      playsinline: true
                  }}
                {%- elsif block.settings.external_video != blank -%}
                  {{ block.settings.external_video | external_video_tag: class: 'grid-video-bg', loading: 'lazy' }}
                {%- elsif block.settings.video_mp4_url != blank -%}
                  <video
                    class="grid-video-bg"
                    {% if b.video_muted %}muted{% endif %}
                    {% if b.video_loop %}loop{% endif %}
                    {% if b.video_autoplay %}autoplay{% endif %}
                    playsinline
                    {% if b.video_controls %}controls{% endif %}
                    preload="metadata"
                  >
                    <source src="{{ b.video_mp4_url }}" type="video/mp4">
                  </video>
                {%- endif -%}
              {%- else -%}
                {% if b.image != blank %}
                  {{ b.image | image_url: width: 1800 | image_tag: loading: 'lazy', class: 'pgrid__img', sizes: '(min-width: 1200px) 600px, (min-width: 750px) 50vw, 100vw', widths: '600,900,1200,1600', alt: b.title | escape }}
                {% else %}
                  <div class="pgrid__color" style="background: {{ b.bg_color }}"></div>
                {% endif %}
              {%- endif -%}

              {%- if b.pinterest_url != blank -%}
                <a
                  href="{{ b.pinterest_url }}"
                  class="pgrid__pin"
                  target="_blank"
                  rel="noopener"
                >
                  <span class="svg-wrapper">{{ 'icon-custom-pinterest.svg' | inline_asset_content }}</span>
                  <span class="pgrid__pin-text">Save</span>
                </a>
              {%- endif -%}

              {%- if b.share_url != blank or download_href != blank or b.visit_link  != blank -%}
                <div class="pgrid__mini">
                 {% if b.visit_link != blank %}
                    <a
                      href="{{ b.visit_link }}"
                      class="pgrid__mini-btn pgrid__mini-btn--visit"
                      target="_blank"
                      rel="noopener"
                    >
                      <span class="svg-wrapper iconshare">{{ 'arrow-bottom-left.svg' | inline_asset_content }}</span>
                      <span class="pgrid__mini-label">Visit Link</span>
                    </a>
                  {% endif %}                  
                  {% if b.share_url != blank %}
                    <a
                      href="{{ b.share_url }}"
                      class="pgrid__mini-btn pgrid__mini-btn--share"
                      target="_blank"
                      rel="noopener"
                    >
                      <span class="svg-wrapper iconshare">{{ 'icon-send.svg' | inline_asset_content }}</span>
                      <span class="pgrid__mini-label">Share</span>
                    </a>
                  {% endif %}
                  {% if download_href != blank %}
                    <a
                      href="{{ download_href }}"
                      class="pgrid__mini-btn pgrid__mini-btn--download"
                      download
                    >
                      <span class="svg-wrapper share">{{ 'icon-custom-download.svg' | inline_asset_content }}</span>
                      <span class="visually-hidden">Download</span>
                    </a>
                  {% endif %}
                </div>
              {%- endif -%}

              <div class="pgrid__overlay" aria-hidden="true"></div>

              <div
                class="pgrid__content pgrid__content--{{ b.content_align }} pgrid__content--{{ b.content_valign }}"
                style="
                  --title-color: {{ b.title_color }};
                  --text-color: {{ b.text_color }};
                  {% if b.title_size != blank %}--title-size: {{ b.title_size }}px;{% endif %}
                  {% if b.text_size != blank %}--text-size: {{ b.text_size }}px;{% endif %}
                "
              >
                {% if b.kicker != blank %}
                  <p class="pgrid__kicker">{{ b.kicker }}</p>
                {% endif %}
                {% if b.title != blank %}
                  <h3 class="pgrid__card-title">{{ b.title }}</h3>
                {% endif %}
                {% if b.text != blank %}
                  <div class="pgrid__card-text">{{ b.text }}</div>
                {% endif %}

                {%- if show_actions and b.action_view_more or b.action_add_enable and p != blank and v != blank -%}
                  <div class="pgrid__actions">
                    {%- if b.action_view_more and link_url != blank -%}
                      <a
                        class="pgrid__btn pgrid__btn--solid"
                        href="{{ link_url }}"
                        {% if b.open_new %}target="_blank" rel="noopener"{% endif %}
                      >
                        {{ b.action_view_label | default: 'Ver más' }}
                      </a>
                    {%- endif -%}

                    {%- if b.action_add_enable and p != blank and v != blank -%}
                      <button
                        type="button"
                        class="pgrid__btn pgrid__btn--solid js-pgrid-add"
                        data-vid="{{ v.id }}"
                        data-qty="{{ b.action_qty | default: 1 }}"
                        {% unless can_add %}disabled{% endunless %}
                      >
                        {{ b.action_add_label | default: 'Agregar al carrito' }}
                      </button>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endcapture -%}

        <div
          class="pgrid__item pgrid__item--{{ forloop.index }}"
          {{ block.shopify_attributes }}
        >
          {{ card }}
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="pgrid-modal" aria-hidden="true">
    <div class="pgrid-modal__backdrop"><span></span></div>
    <div class="pgrid-modal__dialog" role="dialog" aria-modal="true" aria-label="Preview">
      <button class="pgrid-modal__close" type="button" aria-label="Close">✕</button>
      <div class="pgrid-modal__body"></div>
    </div>
  </div>

  <style>

    #pgrid-{{ section.id }} .grid-video-bg{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; z-index:0;
    }

    #pgrid-{{ section.id }} .visually-hidden{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    #pgrid-{{ section.id }}.pgrid{
      position: relative;
      padding: clamp(32px, 6vw, 64px) 0;
    }

    #pgrid-{{ section.id }} .pgrid__header{ margin-bottom: 24px; }
    #pgrid-{{ section.id }} .pgrid__header--left{ text-align:left; }
    #pgrid-{{ section.id }} .pgrid__header--center{ text-align:center; }
    #pgrid-{{ section.id }} .pgrid__header--right{ text-align:right; }
    #pgrid-{{ section.id }} .pgrid__title{ margin:0 0 8px; line-height:1.15; }
    #pgrid-{{ section.id }} .pgrid__subtext :where(p){ margin:0; opacity:.9; }

    #pgrid-{{ section.id }} .pgrid__grid{
      display:grid;
      gap: var(--gap);
    }

    #pgrid-{{ section.id }} .pgrid__item{
      display:block;
      text-decoration:none;
      color:inherit;
      border-radius: var(--radius, 8px);
      overflow:hidden;
      cursor:pointer;
      outline: none;
    }

    #pgrid-{{ section.id }} .pgrid__card{
      height: 100%;
      border-radius: var(--radius, 8px);
      overflow:hidden;
      position:relative;
    }

    #pgrid-{{ section.id }} .pgrid__media{ position:relative; height:100%; }

    #pgrid-{{ section.id }} .pgrid__img,
    #pgrid-{{ section.id }} .pgrid__color{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; display:block;
      transition: transform .35s ease;
    }

    #pgrid-{{ section.id }} .pgrid__overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.8) 75%);
      mix-blend-mode: normal;
      opacity: var(--overlay-op,.35);
      pointer-events:none;
    }

    #pgrid-{{ section.id }} .pgrid__content{
      position:relative;
      z-index:1;
      height:100%;
      padding: clamp(16px, 2.8vw, 24px);
      display:grid;
      gap:.6rem;
      background: var(--content-bg, transparent);
    }
    #pgrid-{{ section.id }} .pgrid__content--left{ justify-items:start; }
    #pgrid-{{ section.id }} .pgrid__content--center{ justify-items:center; text-align:center; }
    #pgrid-{{ section.id }} .pgrid__content--right{ justify-items:end; text-align:right; }
    #pgrid-{{ section.id }} .pgrid__content--top{ align-content:start; }
    #pgrid-{{ section.id }} .pgrid__content--middle{ align-content:center; }
    #pgrid-{{ section.id }} .pgrid__content--bottom{ align-content:end; }

    #pgrid-{{ section.id }} .pgrid__kicker{
      margin:0 0 4px;
      font-weight:600;
      color: var(--title-color);
      letter-spacing:.02em;
      text-transform:none;
    }
    #pgrid-{{ section.id }} .pgrid__card-title{
      margin:0;
      font-size: var(--title-size, clamp(18px, 2.4vw, 28px));
      line-height:1.2;
      color: var(--title-color, #fff);
    }
    #pgrid-{{ section.id }} .pgrid__card-text{
      margin-top:2px;
      color: var(--text-color, #fff);
      opacity:.95;
      font-size: var(--text-size, 14px);
    }
    #pgrid-{{ section.id }} .pgrid__card-title p{
      margin: 0;      
    }
    #pgrid-{{ section.id }} .pgrid__card-text p{
      margin-top: 0;
      margin-bottom: 40px;      
    }

    #pgrid-{{ section.id }} .pgrid__pin{
      position:absolute; top:12px; right:12px;
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 6px;
      border-radius:2px;
      background:#E60023; color:#fff;
      font-size:12px; font-weight:600;
      text-decoration:none;
      z-index: 2;
      box-shadow:0 4px 10px rgba(0,0,0,0.4);
    }
    #pgrid-{{ section.id }} .pgrid__pin:hover{ background:#c0001d; }
    #pgrid-{{ section.id }} .pgrid__pin .svg-wrapper{ width:16px; height:16px; }
    #pgrid-{{ section.id }} .pgrid__pin-text{ letter-spacing:.04em; }

    #pgrid-{{ section.id }} .pgrid__mini{
      position:absolute;
      left:16px;
      bottom:6px;
      display:flex;
      gap:6px;
      z-index:3;
    }
    #pgrid-{{ section.id }} .pgrid__mini-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      padding:0;
      font-size:8px;
      text-transform: uppercase;      
      font-weight:600;
      text-decoration:none;
      border:none;
      cursor:pointer;
      transition:transform .18s ease;
    }
    #pgrid-{{ section.id }} .pgrid__mini-btn--share, #pgrid-{{ section.id }} .pgrid__mini-btn--visit{ 
      padding-inline: 5px;
      padding-top: 2px;
      padding-bottom: 2px;      
      gap: 2px;
      background-color: rgba(255, 255, 255, 0.5);      
      color: #000000;
      border-radius: 2px;    
    }

    #pgrid-{{ section.id }} .icon-arrow-diagonal{ 
      transform: rotate(-180deg);
    }

    #pgrid-{{ section.id }} .pgrid__mini-btn--download{
      width:30px; padding-inline:0; transform: rotate(-180deg);
    }

    #pgrid-{{ section.id }} .pgrid__actions{
      display:flex; gap:.5rem; flex-wrap:wrap; margin-top:10px;
    }
    #pgrid-{{ section.id }} .pgrid__btn{
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.55rem .9rem;
      font-weight:600;
      text-decoration:none;
      border-radius:999px;
      transition:transform .15s ease, background .15s ease, color .15s ease;
      border:1px solid rgba(255,255,255,.9);
      backdrop-filter: saturate(110%) blur(2px);
    }
    #pgrid-{{ section.id }} .pgrid__btn--solid{
      background-color: rgba(var(--color-button),var(--alpha-button-background));
      color: rgb(var(--color-button-text));
    }
    #pgrid-{{ section.id }} .pgrid__btn:hover{ transform: translateY(-1px); }

    #pgrid-{{ section.id }} .pgrid__item:hover .pgrid__img{ transform: scale(1.04); }

    /* ================================
      PGRID – Custom elegant scrollbar
    ================================ */

    /* Firefox */
    .pgrid {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 215, 160, 0.45) rgba(255, 255, 255, 0.08);
    }

    /* Webkit browsers (Chrome, Edge, Safari) */
    .pgrid::-webkit-scrollbar {
      height: 8px;              /* horizontal scrollbar */
    }

    .pgrid::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
    }

    .pgrid::-webkit-scrollbar-thumb {
      background: linear-gradient(
        90deg,
        rgba(255, 215, 160, 0.35),
        rgba(255, 180, 120, 0.55)
      );
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    /* Hover state */
    .pgrid::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(
        90deg,
        rgba(255, 215, 160, 0.55),
        rgba(255, 180, 120, 0.85)
      );
    }

    @media (max-width: 1199px){
      #pgrid-{{ section.id }} .pgrid__content{
        min-height: 320px;        
      }
    }

    @media (min-width: 1200px){
      #pgrid-{{ section.id }} .pgrid__grid{
        grid-template-columns: 1.05fr 1.05fr 1.05fr 1.6fr;
        grid-auto-rows: 220px;
        max-height: 500px;
        overflow-y: hidden;
        overflow: auto;        
      }
      
      #pgrid-{{ section.id }} .pgrid__item--1{ grid-column:1; grid-row:1; }
      #pgrid-{{ section.id }} .pgrid__item--5{ grid-column:1; grid-row:2; }
      #pgrid-{{ section.id }} .pgrid__item--2{ grid-column:2; grid-row:1 / span 2; }
      #pgrid-{{ section.id }} .pgrid__item--3{ grid-column:3; grid-row:1; }
      #pgrid-{{ section.id }} .pgrid__item--6{ grid-column:3; grid-row:2; }
      #pgrid-{{ section.id }} .pgrid__item--4{ grid-column:4; grid-row:1 / span 2; }
    }

    /* Tablet */
    @media (min-width: 750px) and (max-width: 1199px){
      #pgrid-{{ section.id }} .pgrid__grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      #pgrid-{{ section.id }} .pgrid__card{ height: 100%; }
    }

    /* Mobile */
    @media (max-width: 749px){
      #pgrid-{{ section.id }} .pgrid__grid{ grid-template-columns: 1fr; }
      #pgrid-{{ section.id }} .pgrid__card{ height: var(--h-mobile); }
    }

    /* ========= MODAL ========= */
    html.pgrid-modal-open{ overflow:hidden; }
    #pgrid-{{ section.id }} .pgrid-modal{
      position:fixed; inset:0; z-index:60; display:none;
    }
    #pgrid-{{ section.id }} .pgrid-modal.is-open{ display:block; }
    #pgrid-{{ section.id }} .pgrid-modal__backdrop{
      position:absolute; inset:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter: blur(6px);
    }
    #pgrid-{{ section.id }} .pgrid-modal__dialog{
      position:absolute; inset:4vh 4vw;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    #pgrid-{{ section.id }} .pgrid-modal__body{
      max-width: min(350px, 100%);
      max-height: 100%;
      width:100%;
      pointer-events:auto;
    }
    #pgrid-{{ section.id }} .pgrid-modal__body .pgrid__card{
      height:auto; min-height: min(520px, 80vh);
    }
    #pgrid-{{ section.id }} .pgrid-modal__body .pgrid__media{
      min-height: min(520px, 80vh);
    }
    #pgrid-{{ section.id }} .pgrid-modal__close{
      position:absolute; top:16px; right:20px;
      width:32px; height:32px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.9);
      background:rgba(0,0,0,0.4);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      z-index:3;
      pointer-events:auto;
    }
    #pgrid-{{ section.id }} .pgrid-modal__close:hover{
      background:rgba(0,0,0,0.75);
      box-shadow:0 0 12px rgba(255,255,255,0.8);
    }

    #pgrid-{{ section.id }} .share{ transform: rotate(180deg); }
    #pgrid-{{ section.id }} .iconshare, #pgrid-{{ section.id }} .iconshare svg{ stroke:#000000; }

    #pgrid-{{ section.id }} .pgrid-modal__body .pgrid__media{
      display: flex;
      justify-content: center;
      align-items: center;      
    }

    #pgrid-{{ section.id }} .pgrid-modal__body .pgrid__content{
      width: 100%;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      #pgrid-{{ section.id }} .pgrid__img,
      #pgrid-{{ section.id }} .pgrid__color{
        transition: none !important;
      }
      #pgrid-{{ section.id }} .pgrid__item:hover .pgrid__img{
        transform:none !important;
      }
    }
  </style>

  <script>
    (function(){
      var root = document.getElementById('pgrid-{{ section.id }}');
      if(!root) return;

      /* =========================
         Helpers: videos
      ========================= */
      function pauseAllVideos(scope){
        if(!scope) return;
        scope.querySelectorAll('video').forEach(function(v){
          try { v.pause(); } catch(e){}
        });
      }

      /* =========================
         Add to cart (robusto)
      ========================= */
      root.addEventListener('click', function(e){
        var btn = e.target.closest('.js-pgrid-add');
        if(!btn || !root.contains(btn)) return;

        e.stopPropagation(); // no abrir modal

        var vid = btn.getAttribute('data-vid');
        var qty = parseInt(btn.getAttribute('data-qty') || '1', 10);
        if(!vid) return;

        var original = btn.textContent;
        btn.disabled = true;

        var sections = ['cart-notification-product', 'cart-notification-button', 'cart-icon-bubble'];
        var fd = new FormData();
        fd.append('id', vid);
        fd.append('quantity', qty);
        fd.append('sections', sections.join(','));
        fd.append('sections_url', window.location.pathname);

        var addUrl = (window.routes && window.routes.cart_add_url) ? window.routes.cart_add_url : '/cart/add.js';
        // si por alguna razón viene "/cart/add", forzamos .js
        if(addUrl === '/cart/add') addUrl = '/cart/add.js';

        fetch(addUrl, { method:'POST', headers:{ 'Accept':'application/json' }, body: fd })
          .then(function(r){
            if(!r.ok) return r.json().then(function(err){ throw err; });
            return r.json();
          })
          .then(function(parsed){
            var cn = document.querySelector('cart-notification');
            if (cn && typeof cn.renderContents === 'function') {
              cn.renderContents(parsed);
            } else if (parsed.sections && parsed.sections['cart-icon-bubble']) {
              var tmp = document.createElement('div');
              tmp.innerHTML = parsed.sections['cart-icon-bubble'];
              var newBubble = tmp.querySelector('#cart-icon-bubble');
              var curBubble = document.getElementById('cart-icon-bubble');
              if (newBubble && curBubble) curBubble.innerHTML = newBubble.innerHTML;
            }
          })
          .catch(function(err){
            console.error('Cart error:', err);
            btn.textContent = (err && err.description) ? err.description : 'Error';
          })
          .finally(function(){
            setTimeout(function(){
              btn.disabled = false;
              btn.textContent = original;
            }, 1200);
          });
      });

      /* =========================
         Modal full-screen
      ========================= */
      var modal = root.querySelector('.pgrid-modal');
      if(!modal) return;

      var modalBody  = modal.querySelector('.pgrid-modal__body');
      var closeBtn   = modal.querySelector('.pgrid-modal__close');
      var backdrop   = modal.querySelector('.pgrid-modal__backdrop');
      var lastFocus  = null;

      function openModalFromCard(card){
        if(!card || !modalBody) return;

        lastFocus = document.activeElement;

        // Pausar videos del grid (por si estaban reproduciendo)
        pauseAllVideos(root);

        modalBody.innerHTML = '';
        var clone = card.cloneNode(true);
        clone.classList.add('pgrid__card--modal');

        // Si el clon tiene <video>, forzamos controles en modal
        clone.querySelectorAll('video').forEach(function(v){
          try{
            v.muted = false;
            v.setAttribute('controls','true');
            v.removeAttribute('autoplay');
            v.removeAttribute('playsinline'); // opcional en modal
          }catch(e){}
        });

        modalBody.appendChild(clone);

        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden','false');
        document.documentElement.classList.add('pgrid-modal-open');

        // Focus al botón cerrar
        if(closeBtn) closeBtn.focus();

        // Intentar reproducir video del modal si existe y si el original tenía autoplay
        var mv = modalBody.querySelector('video');
        if(mv){
          try { mv.play(); } catch(e){}
        }
      }

      function closeModal(){
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden','true');
        document.documentElement.classList.remove('pgrid-modal-open');

        // Pausar videos del modal antes de limpiar
        pauseAllVideos(modalBody);

        if(modalBody) modalBody.innerHTML = '';

        // restaurar focus
        if(lastFocus && typeof lastFocus.focus === 'function'){
          try { lastFocus.focus(); } catch(e){}
        }
      }

      root.querySelectorAll('.pgrid__item').forEach(function(item){
        item.addEventListener('click', function(e){
          // No abrir modal si se hizo click en botones o tags
          if(e.target.closest('.pgrid__btn, .pgrid__pin, .pgrid__mini-btn')) return;
          var card = item.querySelector('[data-card]');
          if(!card) return;
          openModalFromCard(card);
        });
      });

      if(closeBtn){
        closeBtn.addEventListener('click', function(e){
          e.preventDefault();
          closeModal();
        });
      }
      if(backdrop){
        backdrop.addEventListener('click', function(e){
          e.preventDefault();
          closeModal();
        });
      }

      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && modal.classList.contains('is-open')){
          closeModal();
        }
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Custom Pinterest Grid",
  "tag": "section",
  "class": "section-pinterest-grid",
  "settings": [
    {
      "type": "richtext",
      "id": "heading",
      "label": "Título de la sección",
      "default": "<p>The most beautiful memories are wrapped in <strong>warmth, wonder, and light.</strong></p>"
    },
    { "type": "color", "id": "heading_color", "label": "Color del título", "default": "#FFFFFF" },
    { "type": "range", "id": "heading_size", "label": "Tamaño del título", "min": 24, "max": 72, "step": 1, "unit": "px", "default": 40 },
    {
      "type": "richtext",
      "id": "subtext",
      "label": "Texto de la sección",
      "default": "<p>Shop our daily and monthly specials online or art Lights</p>"
    },
    { "type": "color", "id": "subtext_color", "label": "Color del texto", "default": "#FFFFFF" },
    { "type": "range", "id": "subtext_size", "label": "Tamaño del texto", "min": 12, "max": 28, "step": 1, "unit": "px", "default": 14 },
    {
      "type": "select",
      "id": "header_align",
      "label": "Alineación del título",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ],
      "default": "center"
    },
    { "type": "color", "id": "section_bg_color", "label": "Color de fondo de la sección", "default": "#000000" },
    { "type": "image_picker", "id": "section_bg_image", "label": "Imagen de fondo de la sección" },
    {
      "type": "select",
      "id": "section_bg_type",
      "label": "Fondo de la sección",
      "options": [
        { "value": "color", "label": "Color" },
        { "value": "image", "label": "Imagen" }
      ],
      "default": "color"
    },
    { "type": "color", "id": "section_overlay_color", "label": "Color overlay de la sección", "default": "#000000" },
    { "type": "range", "id": "section_overlay_opacity", "label": "Opacidad overlay sección", "min": 0, "max": 100, "step": 5, "unit": "%", "default": 40 },
    { "type": "color_scheme", "id": "color_scheme", "label": "t:sections.all.colors.label", "default": "scheme-1" },
    { "type": "range", "id": "gap", "label": "Separación entre tarjetas", "min": 8, "max": 32, "step": 1, "unit": "px", "default": 16 }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Tarjeta",
      "limit": 6,
      "settings": [
        { "type": "text", "id": "kicker", "label": "Kicker (opcional)", "default": "kicker" },
        { "type": "richtext", "id": "title", "label": "Título", "default": "<p>Card title</p>" },
        { "type": "richtext", "id": "text", "label": "Texto", "default": "<p>Description text.</p>" },

        { "type": "range", "id": "title_size", "label": "Tamaño título (card)", "min": 14, "max": 24, "step": 2, "unit": "px", "default": 22 },
        { "type": "range", "id": "text_size", "label": "Tamaño texto (card)", "min": 10, "max": 18, "step": 2, "unit": "px", "default": 14 },

        {
          "type": "select",
          "id": "media_type",
          "label": "Tipo de medio",
          "default": "image",
          "options": [
            { "value": "image", "label": "Imagen" },
            { "value": "video", "label": "Video" }
          ]
        },
        { "type": "image_picker", "id": "image", "label": "Imagen de fondo" },
        { "type": "video", "id": "video_file", "label": "Video subido (MP4, mov)", "info": "Se prioriza sobre externo/URL." },
        { "type": "url", "id": "external_video", "label": "Video externo (YouTube/Vimeo)" },
        { "type": "url", "id": "video_mp4_url", "label": "URL MP4 directa (opcional)" },
        { "type": "checkbox", "id": "video_autoplay", "label": "Autoplay", "default": true },
        { "type": "checkbox", "id": "video_loop", "label": "Loop", "default": true },
        { "type": "checkbox", "id": "video_muted", "label": "Muted", "default": true },
        { "type": "checkbox", "id": "video_controls", "label": "Mostrar controles", "default": false },

        { "type": "color", "id": "bg_color", "label": "Color de fondo (si no hay imagen)", "default": "#262626" },
        { "type": "color", "id": "overlay_color", "label": "Overlay (color)", "default": "#000000" },
        { "type": "range", "id": "overlay_opacity", "label": "Overlay (opacidad)", "min": 0, "max": 90, "step": 5, "unit": "%", "default": 35 },

        { "type": "color", "id": "title_color", "label": "Color del título", "default": "#FFE4A6" },
        { "type": "color", "id": "text_color", "label": "Color del texto", "default": "#FFFFFF" },

        {
          "type": "select",
          "id": "content_align",
          "label": "Alineación horizontal del contenido",
          "options": [
            { "value": "left", "label": "Izquierda" },
            { "value": "center", "label": "Centro" },
            { "value": "right", "label": "Derecha" }
          ],
          "default": "left"
        },
        {
          "type": "select",
          "id": "content_valign",
          "label": "Alineación vertical del contenido",
          "options": [
            { "value": "top", "label": "Arriba" },
            { "value": "middle", "label": "Centro" },
            { "value": "bottom", "label": "Abajo" }
          ],
          "default": "bottom"
        },

        { "type": "range", "id": "height_desktop", "label": "Alto base (solo mobile usa valor exacto)", "min": 220, "max": 700, "step": 10, "unit": "px", "default": 360 },
        { "type": "range", "id": "height_mobile", "label": "Alto (mobile)", "min": 180, "max": 600, "step": 10, "unit": "px", "default": 280 },
        { "type": "range", "id": "radius", "label": "Borde redondeado", "min": 0, "max": 28, "step": 1, "unit": "px", "default": 8 },

        { "type": "header", "content": "Enlace principal" },
        {
          "type": "select",
          "id": "link_type",
          "label": "Tipo de enlace",
          "options": [
            { "value": "none", "label": "Sin enlace" },
            { "value": "product", "label": "Producto" },
            { "value": "custom", "label": "URL personalizada" }
          ],
          "default": "none"
        },
        { "type": "product", "id": "product_ref", "label": "Producto" },
        { "type": "url", "id": "link_url", "label": "URL personalizada" },
        { "type": "checkbox", "id": "open_new", "label": "Abrir en nueva pestaña", "default": false },

        { "type": "header", "content": "Acciones" },
        { "type": "checkbox", "id": "actions_enable", "label": "Mostrar acciones (botones)", "default": false },
        { "type": "checkbox", "id": "action_view_more", "label": "— Mostrar botón “Ver más”", "default": false },
        { "type": "text", "id": "action_view_label", "label": "Texto botón Ver más", "default": "Ver más" },
        { "type": "checkbox", "id": "action_add_enable", "label": "— Mostrar botón “Agregar al carrito” (si hay producto)", "default": false },
        { "type": "text", "id": "action_add_label", "label": "Texto botón Agregar", "default": "Agregar al carrito" },
        { "type": "range", "id": "action_qty", "label": "Cantidad al agregar", "min": 1, "max": 10, "step": 1, "default": 1 },

        { "type": "header", "content": "Pinterest / Compartir / Descargar" },
        { "type": "url", "id": "pinterest_url", "label": "URL Pinterest Save" },
        { "type": "url", "id": "share_url", "label": "URL para compartir" },
        { "type": "url", "id": "visit_link", "label": "URL para visitar" },
        { "type": "url", "id": "download_url", "label": "URL de descarga (opcional, si se deja vacío se usa la imagen)" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    { "name": "Custom Pinterest Grid", "category": "Custom" }
  ]
}
{% endschema %}
