{% comment %}
Custom Main Product Section
- Vertical gallery of thumbnails + large main image
- Right column with basic product information
- Configurable background with color and image

{% endcomment %}

{%- assign gallery_media = product.media | where: 'media_type', 'image' -%}
{%- if gallery_media.size == 0 -%}
  {%- assign gallery_media = product.media -%}
{%- endif -%}

{%- capture section_background_style -%}
  background-color: {{ section.settings.bg_color }};
  {% if section.settings.bg_image != blank %}
    background-image: url({{ section.settings.bg_image | image_url: width: 2400 }});
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
  {% endif %}
{%- endcapture -%}

<section
  id="CustomProductMain-{{ section.id }}"
  class="via-pdp-main via-pdp-main--{{ section.id }}"
  style="{{ section_background_style | strip_newlines }}"
>
  <div class="via-pdp-main__overlay"></div>

  <div class="page-width">
    <div class="via-pdp-main__inner">
      {%- if gallery_media.size > 0 -%}
        <div class="via-pdp-main__gallery" data-media-count="{{ gallery_media.size }}">
          <!-- Columna de miniaturas -->
          <div class="via-pdp-gallery-thumbs-wrap">
            <button
              type="button"
              class="via-pdp-thumb-nav via-pdp-thumb-nav--prev vertical-nav nav-down"
              aria-label="{{ 'general.slider.previous_slide' | t }}"
            >
              {{ 'single-right-arrow-icon.svg' | inline_asset_content }}
            </button>

            <div class="via-pdp-gallery-thumbs" data-scroll-step="{{ section.settings.thumb_scroll_step }}">
              {%- for media in gallery_media -%}
                <button
                  type="button"
                  class="via-pdp-thumb{% if forloop.first %} is-active{% endif %}"
                  data-index="{{ forloop.index0 }}"
                  aria-label="{{ 'products.product.media.load_image' | t: index: forloop.index }}"
                >
                  <div class="via-pdp-thumb__inner">
                    {{
                      media.preview_image
                      | image_url: width: 360
                      | image_tag:
                        loading: 'lazy',
                        sizes: '120px',
                        widths: '120, 180, 240, 360'
                    }}
                  </div>
                </button>
              {%- endfor -%}
            </div>

            <button
              type="button"
              class="via-pdp-thumb-nav via-pdp-thumb-nav--next vertical-nav nav-up"
              aria-label="{{ 'general.slider.next_slide' | t }}"
            >
              {{ 'single-left-arrow-icon.svg' | inline_asset_content }}
            </button>
          </div>

          <!-- Imagen principal -->
          <div class="via-pdp-gallery-main">
            <button
              type="button"
              class="via-pdp-main-nav via-pdp-main-nav--prev"
              aria-label="{{ 'general.slider.previous_slide' | t }}"
            >
              {{ 'single-left-arrow-icon.svg' | inline_asset_content }}
            </button>

            <div class="via-pdp-main-frame">
              {%- for media in gallery_media -%}
                <div
                  class="via-pdp-main-slide{% if forloop.first %} is-active{% endif %}"
                  data-index="{{ forloop.index0 }}"
                >
                  {{
                    media.preview_image
                    | image_url: width: 1946
                    | image_tag:
                      loading: 'lazy',
                      sizes: '(min-width: 1200px) 780px, (min-width: 750px) 70vw, 100vw',
                      widths: '600, 900, 1200, 1500, 1946',
                      class: 'via-pdp-main-image'
                  }}
                </div>
              {%- endfor -%}
            </div>

            <button
              type="button"
              class="via-pdp-main-nav via-pdp-main-nav--next"
              aria-label="{{ 'general.slider.next_slide' | t }}"
            >
              {{ 'single-right-arrow-icon.svg' | inline_asset_content }}
            </button>
          </div>
        </div>
      {%- endif -%}

      <!-- Columna derecha: información de producto -->
      <div class="via-pdp-main__info" id="ProductInfo-{{ section.id }}">
        {% comment %} <div class="via-pdp-breadcrumb">
          {{ 'products.product.vendor' | t }}
        </div> {% endcomment %}

        <h1 class="via-pdp-title">{{ product.title | escape }}</h1>

        {%- if section.settings.show_rating and product.metafields.reviews.rating.value != blank -%}
          <div class="via-pdp-rating">
            {% assign rating = product.metafields.reviews.rating.value %}
            {% for i in (1..5) %}
              <span class="via-pdp-star{% if i <= rating %} via-pdp-star--filled{% endif %}">★</span>
            {% endfor %}
          </div>
        {%- endif -%}

        <div class="via-pdp-price">
          {%- if product.compare_at_price > product.price -%}
            <span class="via-pdp-price__current">
                {{ product.price | money }}
            </span>            
          {%- endif -%}
            <span class="via-pdp-price__compare">
              {{ product.compare_at_price | money }}
            </span>
          {%- if product.compare_at_price > product.price -%}
            <span class="via-pdp-price__badge">
              {{ 'products.product.on_sale' | t }}
            </span>
          {%- endif -%}
        </div>
  
        {%- assign product_form_id = 'product-form-' | append: section.id -%}

        <product-form class="via-pdp-form" data-section-id="{{ section.id }}">
          <div id="Quantity-Form-{{ section.id }}"
              class="product-form__input product-form__quantity"
              {{ block.shopify_attributes }}>
              
            {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}

            <div class="btn-wrapper">
              <div class="price-per-item__container">
                <quantity-input class="quantity" data-url="{{ product.url }}" data-section="{{ section.id }}">
                  <button class="quantity__button" name="minus" type="button">
                    <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: product.title | escape }}</span>
                    <span class="svg-wrapper">{{ 'icon-minus.svg' | inline_asset_content }}</span>
                  </button>

                  <input
                    class="quantity__input"
                    type="number"
                    name="quantity"
                    id="Quantity-{{ section.id }}"
                    data-cart-quantity="{{ cart_qty }}"
                    data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    {% if product.selected_or_first_available_variant.quantity_rule.max != null %}
                      data-max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                      max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                    {% endif %}
                    step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}"
                    value="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                    form="{{ product_form_id }}"
                  >

                  <button class="quantity__button" name="plus" type="button">
                    <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: product.title | escape }}</span>
                    <span class="svg-wrapper">{{ 'icon-plus.svg' | inline_asset_content }}</span>
                  </button>
                </quantity-input>
              </div>

              <div class="add-to-cart">
                {%- render 'buy-buttons',
                  block: block,
                  product: product,
                  product_form_id: product_form_id,
                  section_id: section.id,
                  show_pickup_availability: true
                -%}
              </div>
            </div>
          </div>
        </product-form>


        <div class="product-tabs">

        </div>

        {%- if product.description != blank and section.settings.show_description -%}
          <div class="via-pdp-description rte">
            {{ product.description }}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>

  {{ 'custom-main-product.css' | asset_url | stylesheet_tag }}

  <style>
    .via-pdp-main.via-pdp-main--{{ section.id }} {
    position: relative;
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }
    .via-pdp-main__overlay {
        position: absolute;
        inset: 0;
        background: {{ section.settings.bg_overlay_color }};
        opacity: {{ section.settings.bg_overlay_opacity | divided_by: 100.0 }};
        pointer-events: none;
    }
    .via-pdp-btn--primary {
      background: {{ section.settings.button_bg }};
      color: {{ section.settings.button_text }};
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
    }

    .via-pdp-btn--primary:hover {
      background: {{ section.settings.button_bg_hover }};
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    }
    @media (min-width: 750px) {
    .via-pdp-main.via-pdp-main--{{ section.id }} {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    }
    }
  </style>

  <script>
    (function() {
      var sectionId = '{{ section.id }}';
      var root = document.getElementById('CustomProductMain-' + sectionId);
      if (!root) return;

      var gallery = root.querySelector('.via-pdp-main__gallery');
      if (!gallery) return;

      var slides = gallery.querySelectorAll('.via-pdp-main-slide');
      var thumbs = gallery.querySelectorAll('.via-pdp-thumb');
      if (!slides.length || !thumbs.length) return;

      var currentIndex = 0;

      function showSlide(index) {
        var max = slides.length - 1;
        if (index < 0) index = max;
        if (index > max) index = 0;
        currentIndex = index;

        slides.forEach(function(slide) {
          if (parseInt(slide.getAttribute('data-index'), 10) === index) {
            slide.classList.add('is-active');
          } else {
            slide.classList.remove('is-active');
          }
        });

        thumbs.forEach(function(thumb) {
          if (parseInt(thumb.getAttribute('data-index'), 10) === index) {
            thumb.classList.add('is-active');
            scrollThumbIntoView(thumb);
          } else {
            thumb.classList.remove('is-active');
          }
        });
      }

      function scrollThumbIntoView(thumb) {
        var container = root.querySelector('.via-pdp-gallery-thumbs');
        if (!container) return;
        var rect = thumb.getBoundingClientRect();
        var cRect = container.getBoundingClientRect();

        if (rect.top < cRect.top) {
          container.scrollBy({ top: rect.top - cRect.top - 8, behavior: 'smooth' });
        } else if (rect.bottom > cRect.bottom) {
          container.scrollBy({ top: rect.bottom - cRect.bottom + 8, behavior: 'smooth' });
        }
      }

      thumbs.forEach(function(thumb) {
        thumb.addEventListener('click', function() {
          var idx = parseInt(thumb.getAttribute('data-index'), 10);
          showSlide(idx);
        });
      });

      var mainPrev = gallery.querySelector('.via-pdp-main-nav--prev');
      var mainNext = gallery.querySelector('.via-pdp-main-nav--next');

      if (mainPrev) {
        mainPrev.addEventListener('click', function() {
          showSlide(currentIndex - 1);
        });
      }

      if (mainNext) {
        mainNext.addEventListener('click', function() {
          showSlide(currentIndex + 1);
        });
      }

      var thumbPrev = gallery.querySelector('.via-pdp-thumb-nav--prev');
      var thumbNext = gallery.querySelector('.via-pdp-thumb-nav--next');
      var thumbContainer = gallery.querySelector('.via-pdp-gallery-thumbs');
      var scrollStep = parseInt(thumbContainer.getAttribute('data-scroll-step'), 10) || 160;

      if (thumbPrev) {
        thumbPrev.addEventListener('click', function() {
          thumbContainer.scrollBy({ top: -scrollStep, behavior: 'smooth' });
        });
      }

      if (thumbNext) {
        thumbNext.addEventListener('click', function() {
          thumbContainer.scrollBy({ top: scrollStep, behavior: 'smooth' });
        });
      }

      // Qty controls (si algún día los usas con las clases via-pdp-qty__)
      var qtyMinus = root.querySelector('.via-pdp-qty__button--minus');
      var qtyPlus = root.querySelector('.via-pdp-qty__button--plus');
      var qtyInput = root.querySelector('.via-pdp-qty__input');

      if (qtyMinus && qtyPlus && qtyInput) {
        qtyMinus.addEventListener('click', function() {
          var value = parseInt(qtyInput.value || '1', 10);
          if (value > 1) qtyInput.value = value - 1;
        });

        qtyPlus.addEventListener('click', function() {
          var value = parseInt(qtyInput.value || '1', 10);
          qtyInput.value = value + 1;
        });
      }

      window.addEventListener('load', function() {
        var tabsTarget = root.querySelector('.product-tabs');
        if (!tabsTarget) return;

        var externalTabsSection =
          document.querySelector('section.product-spec-tabs') ||
          document.querySelector('section[id^="ProductTabs-template"]');

        if (!externalTabsSection) return;

        if (tabsTarget.contains(externalTabsSection)) return;

        tabsTarget.appendChild(externalTabsSection);
      });
    })();
  </script>

</section>

{% schema %}
{
  "name": "Custom product main",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Top padding",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Bottom padding",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 60
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#f6eee5"
    },
    {
      "type": "image_picker",
      "id": "bg_image",
      "label": "Background image"
    },
    {
      "type": "color",
      "id": "bg_overlay_color",
      "label": "Overlay color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "bg_overlay_opacity",
      "label": "Overlay opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "default": 40
    },
    {
      "type": "header",
      "content": "Gallery"
    },
    {
      "type": "range",
      "id": "thumb_scroll_step",
      "label": "Thumbnail scroll step (px)",
      "min": 80,
      "max": 260,
      "step": 10,
      "default": 160
    },
    {
      "type": "header",
      "content": "Buttons"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Primary button background",
      "default": "#13192b"
    },
    {
      "type": "color",
      "id": "button_bg_hover",
      "label": "Primary button background (hover)",
      "default": "#060b18"
    },
    {
      "type": "color",
      "id": "button_text",
      "label": "Primary button text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show product description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show rating metafield (reviews.rating)",
      "default": false
    }
  ],
  "blocks": [

  ],
  "presets": [
    {
      "name": "Custom product main",
      "category": "Product"
    }
  ]
}
{% endschema %}
