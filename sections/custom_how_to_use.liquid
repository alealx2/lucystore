{% comment %}
  Section: How to Use (con imagen o video + invertir columnas)
  Metacampos soportados:
    - custom.how_to_use_image / custom.features_image : File (imagen o video) o URL (YouTube/Vimeo)
    - custom.how_to_use_text / custom.features_text   : Texto multilínea con <br> entre pasos
{% endcomment %}

{%- assign reverse = section.settings.reverse_layout -%}

<section 
  class="howto howto-{{ section.id }}{% if reverse %} howto--reverse{% endif %} section-{{ section.id }}-padding color-{{ section.settings.color_scheme }}"
>
  <div class="howto__grid">

    {%- if section.settings.media_type == 'how' -%}

      <div class="howto__col howto__col--left page-width">
        {% if section.settings.heading != blank %}
          <h2 class="howto__title">{{ section.settings.heading }}</h2>
        {% endif %}

        {% assign steps_mf = product.metafields.custom.how_to_use_text %}
        {% assign steps_array = blank %}

        {% if steps_mf != blank %}
          {% assign raw_value = steps_mf.value | default: steps_mf %}
          {% assign normalized = raw_value | strip %}
          {% assign steps_array = normalized | split: '<br>' %}
        {% endif %}

        {% if steps_array and steps_array.size > 0 %}
          <ol class="howto__list" role="list">
            {% assign counter = 0 %}
            {% for s in steps_array %}
              {% assign clean = s | strip %}
              {% if clean != '' %}
                {% assign counter = counter | plus: 1 %}
                <li class="howto__item">
                  <div class="howto__badge" aria-hidden="true">{{ counter }}</div>
                  <div class="howto__text">{{ clean }}</div>
                </li>
              {% endif %}
            {% endfor %}
          </ol>
        {% else %}
          <p class="howto__empty">meta campo no cargado para este producto</p>
        {% endif %}
      </div>

      <div class="howto__col howto__col--right">
       
        {% assign media_mf = product.metafields.custom.how_to_use_image %}
        {% assign media_val = media_mf.value | default: media_mf %}

        {% if media_val %}

          {% if  media_val.media_type contains 'video' %}
            <video
              class="howto__video"
              {% if section.settings.video_muted %}muted{% endif %}
              {% if section.settings.video_loop %}loop{% endif %}
              {% if section.settings.video_autoplay %}autoplay{% endif %}
              playsinline
              {% if section.settings.video_controls %}controls{% endif %}
            >
              <source src="{{ media_val | video_tag }}" type="{{ media_val.media_type }}">
            </video>

          {% elsif media_val.media_type contains 'image' %}
            <img
              src="{{ media_val | image_url: width: 1200 }}"
              alt="{{ product.title | escape }}"
              class="howto__image"
              loading="lazy"
              width="{{ media_val.width }}" height="{{ media_val.height }}"
            >
          {% else %}
            <div class="howto__placeholder">{{ 'image' | placeholder_svg_tag: 'placeholder' }}</div>
          {% endif %}
        {% else %}
          <div class="howto__placeholder">{{ 'image' | placeholder_svg_tag: 'placeholder' }}</div>
        {% endif %}
      </div>

    {%- else -%}

      <div class="howto__col howto__col--left page-width">
        {% if section.settings.heading != blank %}
          <h2 class="howto__title">{{ section.settings.heading }}</h2>
        {% endif %}

        {% assign steps_mf = product.metafields.custom.features %}
        {% assign steps_array = blank %}

        {% if steps_mf != blank %}
          {% assign raw_value = steps_mf.value | default: steps_mf %}
          {% assign normalized = raw_value | strip %}
          {% assign steps_array = normalized | split: '<br>' %}
        {% endif %}

        {% if steps_array and steps_array.size > 0 %}
          <ol class="howto__list" role="list">
            {% assign counter = 0 %}
            {% for s in steps_array %}
              {% assign clean = s | strip %}
              {% if clean != '' %}
                {% assign counter = counter | plus: 1 %}
                <li class="howto__item">
                  <div class="howto__badge" aria-hidden="true">{{ counter }}</div>
                  <div class="howto__text">{{ clean }}</div>
                </li>
              {% endif %}
            {% endfor %}
          </ol>
        {% else %}
          <p class="howto__empty">meta campo no cargado para este producto</p>
        {% endif %}
      </div>

      <div class="howto__col howto__col--right">

        {% assign media_mf = product.metafields.custom.feature_image %}
        {% assign media_val = media_mf.value | default: media_mf %}

        {% if media_val %}
          {% if  media_val.media_type contains 'video' %}

            <video
              class="howto__video"
              {% if section.settings.video_muted %}muted{% endif %}
              {% if section.settings.video_loop %}loop{% endif %}
              {% if section.settings.video_autoplay %}autoplay{% endif %}
              playsinline
              {% if section.settings.video_controls %}controls{% endif %}
            >
              <source src="{{ media_val | video_tag }}" type="{{ media_val.media_type }}">
            </video>

          {% elsif media_val.media_type contains 'image' %}
            <img
              src="{{ media_val | image_url: width: 1200 }}"
              alt="{{ product.title | escape }}"
              class="howto__image"
              loading="lazy"
              width="{{ media_val.width }}" height="{{ media_val.height }}"
            >
          {% else %}
            <div class="howto__placeholder">{{ 'image' | placeholder_svg_tag: 'placeholder' }}</div>
          {% endif %}
        {% else %}
          <div class="howto__placeholder">{{ 'image' | placeholder_svg_tag: 'placeholder' }}</div>
        {% endif %}
      </div>

    {%- endif -%}

  </div>

  <style>
    .section-{{ section.id }}-padding{margin-top:{{ section.settings.padding_top | times: 0.75 | round: 0 }}px;margin-bottom:{{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px}

    .howto-{{ section.id }}.howto{
      --howto-gap: clamp(1.5rem, 3vw, 3rem);
      --howto-badge-size: 36px;
      --howto-badge-border: 1.5px;
        border-top: 1px solid {{section.settings.border_color}};
        border-bottom: 1px solid {{section.settings.border_color}};          
    }

    .howto-{{ section.id }} .howto__grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--howto-gap);
      align-items: center;
    }

    .howto-{{ section.id }} .howto__title{
      font-size: {{section.settings.heading_size}}px;
      line-height: 1.1;
      margin: 0 0 40px 0;
      letter-spacing: -0.02em;
    }

    .howto-{{ section.id }} .howto__list{
      list-style: none; margin: 0; padding: 0;
      display: flex; flex-direction: column;
      gap: clamp(0.75rem, 1.2vw, 1.25rem);
    }

    .howto-{{ section.id }} .howto__item{
      display: grid; grid-template-columns: var(--howto-badge-size) 1fr;
      align-items: center; gap: 10px;
    }

    .howto-{{ section.id }} .howto__badge{
      width: var(--howto-badge-size); height: var(--howto-badge-size);
      border-radius: 999px; border: var(--howto-badge-border) solid currentColor;
      display: grid; place-items: center;
      font-weight: 500; font-size: {{section.settings.text_size}}px; line-height: 1;
    }

    .howto-{{ section.id }} .howto__text{ font-size: {{section.settings.text_size}}px; line-height: 1.5; }

    .howto-{{ section.id }} .howto__empty{ margin: .5rem 0 0; font-size: .95rem; opacity: .7; }

    .howto-{{ section.id }} .howto__col--right{ position: relative; min-height: 220px; }

    .howto-{{ section.id }} .howto__image{ width: 100%; height: auto; display: block; object-fit: cover; }

    .howto-{{ section.id }} .howto__video{ width: 100%; height: auto; display: block; border: 0;  }
    .howto-{{ section.id }} .howto__video--ext{ aspect-ratio: 16/9; }

    .howto-{{ section.id }} .howto__placeholder .placeholder{ width: 100%; height: auto; display: block; background: #f3f3f3; }

    @media (min-width: 990px){
      .howto-{{ section.id }} .howto__grid{ grid-template-columns: 1fr 1fr; } 
      .howto-{{ section.id }}.howto--reverse .howto__col--left{ order: 2; }
      .howto-{{ section.id }}.howto--reverse .howto__col--right{ order: 1; }
    }

    @media (max-width: 989px){
      .howto__col--left{ order: 2; width: 100%; padding: 0 0px 40px 20px;}
    }    

</style>
</section>

{% schema %}
{
  "name": "How to Use (PDP)",
  "tag": "section",
  "class": "section howto-wrap",
  "settings": [
    { "type": "select", "id": "media_type", "label": "Tipo Sección", "default": "how",
      "options": [
        { "value": "how", "label": "How to use" },
        { "value": "features", "label": "Features" }
      ]
    },
    { "type": "text", "id": "heading", "label": "Título", "default": "How to Use" },

    { "type": "range", "id": "heading_size", "min": 10, "max": 64, "step": 2, "unit": "px", "label": "Tamaño título", "default": 36 },
    { "type": "range", "id": "text_size", "min": 10, "max": 28, "step": 1, "unit": "px", "label": "Tamaño texto", "default": 16 },

    { "type": "checkbox", "id": "reverse_layout", "label": "Invertir columnas", "default": false },
    {
      "type": "color",
      "id": "border_color",
      "label": "Color del borde",
      "default": "#000000"
    },    
    { "type": "color_scheme", "id": "color_scheme", "label": "Esquema de color", "default": "scheme-1" },
    { "type": "header", "content": "Espaciado" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding superior", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Padding inferior", "default": 40 },

    { "type": "header", "content": "Video (si corresponde)" },
    { "type": "checkbox", "id": "video_autoplay", "label": "Autoplay", "default": true },
    { "type": "checkbox", "id": "video_loop", "label": "Loop", "default": true },
    { "type": "checkbox", "id": "video_muted", "label": "Silenciar", "default": true },
    { "type": "checkbox", "id": "video_controls", "label": "Mostrar controles", "default": false },

  ],
  "presets": [
    { "name": "How to Use (PDP)", "category": "Custom" }
  ]
}
{% endschema %}
