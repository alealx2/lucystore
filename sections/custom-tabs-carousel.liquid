{% comment %}
Carousel Tabs – Section (Dawn / OS 2.0)
- Horizontal tabs
- Each tab: up to 3+ card-type items with a background image or video, title, and button
- Previous/next arrows on the sides
- Global settings for:
· Tab styles
· Card background and overlay
· Text container
{% endcomment %}

{{ 'custom-tabs-carousel.css' | asset_url | stylesheet_tag }}


{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px !important;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px !important;
  }

  @media (max-width: 989px){
    .section-{{ section.id }}-padding {
      padding-top: 20px !important;
      padding-bottom: 20px !important;
    }
  }
{%- endstyle -%}

<section
  id="tc-{{ section.id }}"
  class="tc section-{{ section.id }}-padding customtabs"
  style="
    {% if section.settings.section_bg_type == 'image' and section.settings.section_bg_image != blank %}
      background-image: url({{ section.settings.section_bg_image | image_url: width: 2400 }});
      background-size: cover;
      background-position: center center;
    {% else %}
      background-color: {{ section.settings.section_bg_color }};
    {% endif %}
  "
>
  {% if section.settings.heading != blank %}
    <h2 class="tc__heading page-width">{{ section.settings.heading }}</h2>
  {% endif %}

  <!-- TABS + flechas -->
  <div class="page-width">
    <div class="tc__tabs">

      <button
        type="button"
        class="tc-tabs-arrow tc-tabs-arrow--prev"
        aria-label="{{ 'sections.slideshow.previous_slideshow' | t }}"
      >
        <span class="svg-wrapper">
          {{- 'single-left-arrow-icon.svg' | inline_asset_content -}}
        </span>
      </button>

      <div class="tc__tabs-shell" role="tablist" aria-label="{{ section.settings.heading | default: 'Carousel tabs' | escape }}">
        <span class="tc__indicator tc__indicator--top" aria-hidden="true"></span>
        {% for block in section.blocks %}
          {% assign b = block.settings %}
          <button
            id="tc-tab-{{ block.id }}"
            class="tc-tab__btn{% if forloop.first %} is-active{% endif %}"
            role="tab"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            aria-controls="tc-panel-{{ block.id }}"
            tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
            style="
              --tab-bg: {{ section.settings.tab_bg }};
              --tab-bg-h: {{ section.settings.tab_bg_hover }};
              --tab-fs: {{ section.settings.tab_font_size }}px;
              {% if section.settings.tab_text_color != blank %}--tab-text: {{ section.settings.tab_text_color }};{% endif %}
              {% if section.settings.tab_text_hover_color != blank %}--tab-text-h: {{ section.settings.tab_text_hover_color }};{% endif %}
            "
            data-bg="{{ section.settings.tab_bg | default: '#f2f2f2' }}"
            data-bg-hover="{{ section.settings.tab_bg_hover | default: '#111111' }}"
            data-auto="{{ b.auto_contrast }}"
          >
            {{ b.tab_label | escape }}
          </button>
        {% endfor %}
        <span class="tc__indicator tc__indicator--bottom" aria-hidden="true"></span>
      </div>

      <button
        type="button"
        class="tc-tabs-arrow tc-tabs-arrow--next"
        aria-label="{{ 'sections.slideshow.next_slideshow' | t }}"
      >
        <span class="svg-wrapper">
          {{- 'single-right-arrow-icon.svg' | inline_asset_content -}}
        </span>
      </button>
    </div>
  </div>

  <!-- PANELS -->
  <div class="tc__panels page-width">
    {% for block in section.blocks %}
      {% assign b = block.settings %}

      {%- comment -%}
        Calculamos cuántos items tiene este tab (1–10)
      {%- endcomment -%}
      {% assign cards_count = 0 %}

      {%- assign has_card1 = false -%}
      {% if b.title != blank or b.rich_text != blank or b.button_label != blank %}
        {% assign has_card1 = true %}
      {% endif %}
      {% if b.bg_type == 'image' and b.bg_image != blank %}
        {% assign has_card1 = true %}
      {% endif %}
      {% if b.media_type == 'video' and b.video_file != blank or b.external_video != blank or b.video_mp4_url != blank %}
        {% assign has_card1 = true %}
      {% endif %}
      {% if has_card1 %}
        {% assign cards_count = cards_count | plus: 1 %}
      {% endif %}

      {% for i in (2..10) %}
        {% assign base = 'item_' | append: i | append: '_' %}
        {% assign title_key = base | append: 'title' %}
        {% assign image_key = base | append: 'image' %}
        {% assign video_file_key = base | append: 'video_file' %}
        {% assign external_video_key = base | append: 'external_video' %}
        {% assign video_url_key = base | append: 'video_mp4_url' %}

        {% assign item_title = b[title_key] %}
        {% assign item_image = b[image_key] %}
        {% assign item_video_file = b[video_file_key] %}
        {% assign item_external_video = b[external_video_key] %}
        {% assign item_video_url = b[video_url_key] %}

        {% if item_title != blank or item_image != blank or item_video_file != blank or item_external_video != blank or item_video_url != blank %}
          {% assign cards_count = cards_count | plus: 1 %}
        {% endif %}
      {% endfor %}

      <div
        id="tc-panel-{{ block.id }}"
        class="tc-panel{% if forloop.first %} is-active{% endif %}"
        role="tabpanel"
        aria-labelledby="tc-tab-{{ block.id }}"
        tabindex="0"
      >
        <div
          class="tc-carousel"
          data-items-count="{{ cards_count }}"
          style="
            --min-h-desktop: {{ section.settings.min_height_desktop }}px;
            --min-h-mobile: {{ section.settings.min_height_mobile }}px;
            --content-w: {{ section.settings.content_max_width }}px;
            --content-bg: {% if section.settings.content_bg_enable and section.settings.content_bg != blank %}{{ section.settings.content_bg }}{% else %}transparent{% endif %};
            --content-radius: {{ section.settings.content_bg_radius }}px;
            --overlay: {{ section.settings.overlay_color }};
            --overlay-op: {{ section.settings.overlay_opacity | times: 0.01 }};
            --card-bg: {{ section.settings.card_bg_color }};
          "
        >
          {% if cards_count > 1 %}
            <button
              type="button"
              class="tc-arrow tc-arrow--prev"
              aria-label="{{ 'sections.slideshow.previous_slideshow' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'single-left-arrow-icon.svg' | inline_asset_content -}}
              </span>
            </button>
          {% endif %}

          <div class="tc-items">
            {%- comment -%}
              ITEM 1 (central)
            {%- endcomment -%}
            {% if has_card1 %}
              <article class="tc-item is-active" data-index="0">
                {% if b.media_type == 'video' %}
                  <div class="tc-item__media-wrapper">
                    {% if b.video_file != blank %}
                      {{ b.video_file | video_tag:
                        image_size: '800x',
                        class: 'tc-item__video',
                        autoplay: false,
                        loop: true,
                        muted: true,
                        controls: false,
                        playsinline: true
                      }}
                    {% elsif b.video_mp4_url != blank %}
                      <video class="tc-item__video" muted playsinline loop>
                        <source src="{{ b.video_mp4_url }}" type="video/mp4">
                      </video>
                    {% elsif b.external_video != blank %}
                      {{ b.external_video | external_video_tag: class: 'tc-item__video tc-item__video--external', loading: 'lazy' }}
                    {% endif %}
                  </div>
                {% elsif b.bg_type == 'image' and b.bg_image != blank %}
                  <div class="tc-item__media-wrapper">
                    {%- assign _alt1 = b.bg_image_alt | default: 'image' -%}
                    {{ b.bg_image
                      | image_url: width: 1200
                      | image_tag:
                        loading: 'lazy',
                        class: 'tc-item__media-img',
                        alt: _alt1,
                        style: 'object-position:' | append: b.bg_position
                    }}
                  </div>
                {% endif %}

                <div class="tc-item__overlay" aria-hidden="true"></div>

                <div class="tc-item__content tc-item__content--{{ section.settings.content_align }} tc-item__content--{{ section.settings.content_valign }}" style="color: {{ b.item_txt_color }};">
                  {% if b.title != blank %}
                    <h3 class="tc-item__title" style="color: {{ b.item_txt_color }}; font-size: {{ section.settings.item_title_size }}px;">
                      {{ b.title }}
                    </h3>
                  {% endif %}
                  {% if b.rich_text != blank %}
                    <div class="tc-item__text" style="font-size: {{ section.settings.item_desc_size }}px;">
                      {{ b.rich_text }}
                    </div>
                  {% endif %}
                  {% if b.button_label != blank and b.button_link != blank %}
                    <a
                      class="tc-item__btn"
                      href="{{ b.button_link }}"
                      style="--btn-bg: {{ section.settings.btn_bg }}; --btn-text: {{ section.settings.btn_text }}; --btn-bg-h: {{ section.settings.btn_bg_hover }}; --btn-text-h: {{ section.settings.btn_text_hover }};"
                    >
                      {{ b.button_label }}
                    </a>
                  {% endif %}

                  {% if b.media_type == 'video' %}
                    <div class="tc-item__controls">
                      <button type="button" class="tc-vid-btn tc-vid-btn--play" aria-label="{{ 'sections.slideshow.play_slideshow' | t }}">
                        <span class="svg-wrapper">
                          {{ 'icon-play.svg' | inline_asset_content }}
                        </span>
                      </button>
                      <button type="button" class="tc-vid-btn tc-vid-btn--pause" aria-label="{{ 'sections.slideshow.pause_slideshow' | t }}">
                        <span class="svg-wrapper">
                          {{ 'icon-pause.svg' | inline_asset_content }}
                        </span>
                      </button>
                      <button type="button" class="tc-vid-btn tc-vid-btn--fullscreen" aria-label="Ver en pantalla completa">
                        <span class="svg-wrapper">
                          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M5 9V5h4V3H3v6zm0 6H3v6h6v-2H5zm14 4h-4v2h6v-6h-2zm-4-16v2h4v4h2V3z"></path>
                          </svg>
                        </span>
                      </button>
                    </div>
                  {% endif %}
                </div>
              </article>
            {% endif %}

            {%- comment -%}
              ITEMS 2+ (opcionales)
            {%- endcomment -%}
            {% assign current_index = 0 %}
            {% if has_card1 %}
              {% assign current_index = 1 %}
            {% endif %}

            {% for i in (2..10) %}
              {% assign base = 'item_' | append: i | append: '_' %}
              {% assign media_type_key = base | append: 'media_type' %}
              {% assign image_key = base | append: 'image' %}
              {% assign image_alt_key = base | append: 'image_alt' %}
              {% assign video_file_key = base | append: 'video_file' %}
              {% assign external_video_key = base | append: 'external_video' %}
              {% assign video_url_key = base | append: 'video_mp4_url' %}
              {% assign title_key = base | append: 'title' %}
              {% assign text_key = base | append: 'rich_text' %}
              {% assign btn_label_key = base | append: 'button_label' %}
              {% assign btn_link_key = base | append: 'button_link' %}

              {% assign media_type = b[media_type_key] | default: 'image' %}
              {% assign image = b[image_key] %}
              {% assign image_alt = b[image_alt_key] %}
              {% assign video_file = b[video_file_key] %}
              {% assign external_video = b[external_video_key] %}
              {% assign video_url = b[video_url_key] %}
              {% assign item_title = b[title_key] %}
              {% assign item_text = b[text_key] %}
              {% assign item_btn_label = b[btn_label_key] %}
              {% assign item_btn_link = b[btn_link_key] %}

              {% if item_title != blank or image != blank or video_file != blank or external_video != blank or video_url != blank %}
                <article class="tc-item{% if cards_count == 1 and forloop.first %} is-active{% endif %}" data-index="{{ current_index }}">
                  {% if media_type == 'video' %}
                    <div class="tc-item__media-wrapper">
                      {% if video_file != blank %}
                        {{ video_file | video_tag:
                          image_size: '800x',
                          class: 'tc-item__video',
                          autoplay: false,
                          loop: true,
                          muted: true,
                          controls: false,
                          playsinline: true
                        }}
                      {% elsif video_url != blank %}
                        <video class="tc-item__video" muted playsinline loop>
                          <source src="{{ video_url }}" type="video/mp4">
                        </video>
                      {% elsif external_video != blank %}
                        {{ external_video | external_video_tag: class: 'tc-item__video tc-item__video--external', loading: 'lazy' }}
                      {% endif %}
                    </div>
                  {% elsif image != blank %}
                    <div class="tc-item__media-wrapper">
                      {%- assign _altN = image_alt | default: 'image' -%}
                      {{ image | image_url: width: 1200 | image_tag: loading: 'lazy', class: 'tc-item__media-img', alt: _altN }}
                    </div>
                  {% endif %}

                  <div class="tc-item__overlay" aria-hidden="true"></div>

                  <div class="tc-item__content tc-item__content--{{ section.settings.content_align }} tc-item__content--{{ section.settings.content_valign }}" style="color: {{ b.item_txt_color }};">
                    {% if item_title != blank %}
                      <h3 class="tc-item__title" style="color: {{ b.item_txt_color }}; font-size: {{ section.settings.item_title_size }}px;">
                        {{ item_title }}
                      </h3>
                    {% endif %}
                    {% if item_text != blank %}
                      <div class="tc-item__text" style="font-size: {{ section.settings.item_desc_size }}px;">
                        {{ item_text }}
                      </div>
                    {% endif %}
                    {% if item_btn_label != blank and item_btn_link != blank %}
                      <a
                        class="tc-item__btn"
                        href="{{ item_btn_link }}"
                        style="--btn-bg: {{ section.settings.btn_bg }}; --btn-text: {{ section.settings.btn_text }}; --btn-bg-h: {{ section.settings.btn_bg_hover }}; --btn-text-h: {{ section.settings.btn_text_hover }};"
                      >
                        {{ item_btn_label }}
                      </a>
                    {% endif %}

                    {% if media_type == 'video' %}
                      <div class="tc-item__controls">
                        <button type="button" class="tc-vid-btn tc-vid-btn--play" aria-label="{{ 'sections.slideshow.play_slideshow' | t }}">
                          <span class="svg-wrapper">
                            {{ 'icon-play.svg' | inline_asset_content }}
                          </span>
                        </button>
                        <button type="button" class="tc-vid-btn tc-vid-btn--pause" aria-label="{{ 'sections.slideshow.pause_slideshow' | t }}">
                          <span class="svg-wrapper">
                            {{ 'icon-pause.svg' | inline_asset_content }}
                          </span>
                        </button>
                        <button type="button" class="tc-vid-btn tc-vid-btn--fullscreen" aria-label="Ver en pantalla completa">
                          <span class="svg-wrapper">
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                              <path d="M5 9V5h4V3H3v6zm0 6H3v6h6v-2H5zm14 4h-4v2h6v-6h-2zm-4-16v2h4v4h2V3z"></path>
                            </svg>
                          </span>
                        </button>
                      </div>
                    {% endif %}
                  </div>
                </article>

                {% assign current_index = current_index | plus: 1 %}
              {% endif %}
            {% endfor %}
          </div>

          {% if cards_count > 1 %}
            <button
              type="button"
              class="tc-arrow tc-arrow--next"
              aria-label="{{ 'sections.slideshow.next_slideshow' | t }}"
            >
              <span class="svg-wrapper">
                {{- 'single-right-arrow-icon.svg' | inline_asset_content -}}
              </span>
            </button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>

<!-- MODAL VIDEO FULLSCREEN -->
<div class="tc-modal" aria-hidden="true">
  <div class="tc-modal__inner" role="dialog" aria-modal="true">
    <button type="button" class="tc-modal__close" aria-label="Cerrar video">&times;</button>
    <div class="tc-modal__content"></div>
  </div>
</div>


<script>
  (function(){
    var root = document.getElementById('tc-{{ section.id }}');
    if(!root) return;

    var tabs      = root.querySelectorAll('.tc-tab__btn');
    var panels    = root.querySelectorAll('.tc-panel');
    var wrap      = root.querySelector('.tc__panels');
    var tabsShell = root.querySelector('.tc__tabs-shell');
    var tabsPrev  = root.querySelector('.tc-tabs-arrow--prev');
    var tabsNext  = root.querySelector('.tc-tabs-arrow--next');

    /* =====================
       MODAL FULLSCREEN VIDEO
       ===================== */
    var modal        = root.querySelector('.tc-modal');
    var modalContent = modal && modal.querySelector('.tc-modal__content');
    var modalClose   = modal && modal.querySelector('.tc-modal__close');

    function openModalFromItem(item, mediaEl){
      if(!modal || !modalContent) return;

      modalContent.innerHTML = '';

      var clone = null;

      if(mediaEl){
        clone = mediaEl.cloneNode(true);
        if(clone.tagName === 'VIDEO'){
          clone.setAttribute('controls', 'true');
          clone.muted = false;
          clone.removeAttribute('playsinline');
        }
      } else {
        var iframe = item.querySelector('.tc-item__video--external, iframe');
        if(iframe){
          clone = iframe.cloneNode(true);
        } else {
          var img = item.querySelector('.tc-item__media-img');
          if(img){
            clone = img.cloneNode(true);
          }
        }
      }

      if(clone){
        clone.classList.add('tc-modal__media');
        modalContent.appendChild(clone);
        if(clone.tagName === 'VIDEO'){
          try { clone.play(); } catch(e){}
        }
      }

      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden','false');
      document.body.classList.add('tc-modal-open');
    }

    function closeModal(){
      if(!modal) return;
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden','true');
      if(modalContent){
        modalContent.innerHTML = '';
      }
      document.body.classList.remove('tc-modal-open');
    }

    if(modalClose){
      modalClose.addEventListener('click', function(e){
        e.preventDefault();
        closeModal();
      });
    }
    if(modal){
      modal.addEventListener('click', function(e){
        if(e.target === modal){
          closeModal();
        }
      });
    }
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape' && modal && modal.classList.contains('is-open')){
        closeModal();
      }
    });

    if(tabsShell && tabs.length <= 4){
      tabsShell.classList.add('tc__tabs-shell--no-arrows');
    }

    function scrollTabs(delta){
      if(!tabsShell) return;
      var target = tabsShell.scrollLeft + delta;
      if(typeof tabsShell.scrollTo === 'function'){
        tabsShell.scrollTo({ left: target, behavior: 'smooth' });
      } else {
        tabsShell.scrollLeft = target;
      }
    }

    if(tabsShell){
      if(tabsPrev){
        tabsPrev.addEventListener('click', function(){
          scrollTabs(-tabsShell.clientWidth * 0.7);
        });
      }
      if(tabsNext){
        tabsNext.addEventListener('click', function(){
          scrollTabs(tabsShell.clientWidth * 0.7);
        });
      }
    }

    function hexToRGB(h){
      if(!h) return [255,255,255];
      h = h.replace('#','');
      if(h.length === 3){
        h = h.split('').map(function(c){ return c + c; }).join('');
      }
      var n = parseInt(h,16);
      return [(n>>16)&255, (n>>8)&255, n&255];
    }
    function luminance(r,g,b){
      var a = [r,g,b].map(function(v){
        v/=255;
        return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4);
      });
      return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
    }
    function contrastColor(hex){
      try{
        var rgb = hexToRGB(hex);
        return luminance(rgb[0],rgb[1],rgb[2]) > 0.5 ? '#111111' : '#ffffff';
      }catch(e){
        return '#111111';
      }
    }
    function applyAutoContrast(btn){
      var auto = btn.getAttribute('data-auto') === 'true';
      if(!auto) return;
      var bg  = (btn.getAttribute('data-bg') || '#f2f2f2').trim();
      var bgh = (btn.getAttribute('data-bg-hover') || '#111111').trim();
      btn.style.setProperty('--tab-text',  contrastColor(bg));
      btn.style.setProperty('--tab-text-h',contrastColor(bgh));
    }
    tabs.forEach(applyAutoContrast);

    /* =====================
       Indicador glow tabs
       ===================== */
    function setIndicator(btn){
      if(!btn) return;

      var rect       = btn.getBoundingClientRect();
      var parentRect = btn.parentElement.getBoundingClientRect();

      var extra  = 18;
      var width  = rect.width + extra;
      var offsetX = (rect.left - parentRect.left + btn.parentElement.scrollLeft) - extra/2;

      root.querySelectorAll('.tc__indicator').forEach(function(ind){
        ind.style.width = width + 'px';
        ind.style.transform = 'translateX(' + offsetX + 'px)';
      });
    }

    
    function setHeights(panel){
      if(!wrap || !panel) return;
      wrap.style.height = panel.scrollHeight + 'px';
      panel.querySelectorAll('img').forEach(function(img){
        img.addEventListener('load', function(){
          wrap.style.height = panel.scrollHeight + 'px';
        }, { once: true });
      });
    }


    function activate(btn){
      var id = btn.getAttribute('aria-controls');

      tabs.forEach(function(t){
        t.classList.remove('is-active');
        t.setAttribute('aria-selected','false');
        t.setAttribute('tabindex','-1');
      });
      panels.forEach(function(p){
        p.classList.remove('is-active');
      });

      btn.classList.add('is-active');
      btn.setAttribute('aria-selected','true');
      btn.setAttribute('tabindex','0');

      var panel = root.querySelector('#'+id);
      if(panel){
        panel.classList.add('is-active');
        setHeights(panel);
        setTimeout(function(){ setHeights(panel); }, 80);
      }
      setIndicator(btn);
    }

    tabs.forEach(function(btn, i){
      btn.addEventListener('click', function(e){
        e.preventDefault();
        activate(btn);
      });
      btn.addEventListener('keydown', function(e){
        if(e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
          e.preventDefault();
          var next = (e.key === 'ArrowRight') ? i+1 : i-1;
          if(next < 0) next = tabs.length-1;
          if(next >= tabs.length) next = 0;
          tabs[next].focus();
          activate(tabs[next]);
        }
      });
    });

    var initial = root.querySelector('.tc-tab__btn.is-active') || tabs[0];
    if(initial){
      setIndicator(initial);
      var p = root.querySelector('#'+initial.getAttribute('aria-controls'));
      setHeights(p);
    }

    window.addEventListener('resize', function(){
      var activeTab   = root.querySelector('.tc-tab__btn.is-active');
      var activePanel = root.querySelector('.tc-panel.is-active');
      setIndicator(activeTab);
      setHeights(activePanel);
    });
    if(tabsShell){
      tabsShell.addEventListener('scroll', function(){
        var active = root.querySelector('.tc-tab__btn.is-active');
        setIndicator(active);
      }, { passive:true });
    }

    /* ============================
       VIDEO CONTROLS (cards)
       ============================ */
    function attachVideoControls(item){
      if(item.dataset.videoBound === '1') return;

      var video = item.querySelector('video.tc-item__video');
      if(!video) return;

      var playBtn  = item.querySelector('.tc-vid-btn--play');
      var pauseBtn = item.querySelector('.tc-vid-btn--pause');
      var fullBtn  = item.querySelector('.tc-vid-btn--fullscreen');

      function playVideo(){
        try { video.play(); } catch(e){}
        item.classList.add('is-playing');
      }
      function pauseVideo(){
        try { video.pause(); } catch(e){}
        item.classList.remove('is-playing');
      }

      if(playBtn){
        playBtn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          playVideo();
        });
      }
      if(pauseBtn){
        pauseBtn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          pauseVideo();
        });
      }
      if(fullBtn){
        fullBtn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();

          pauseVideo();

          if(video.requestFullscreen){
            video.requestFullscreen();
          } else if(video.webkitRequestFullscreen){
            video.webkitRequestFullscreen();
          } else if(video.msRequestFullscreen){
            video.msRequestFullscreen();
          } else {
            openModalFromItem(item, video);
          }
        });
      }

      item._pauseVideo = pauseVideo;
      item.dataset.videoBound = '1';
    }

    function pauseItemVideo(item){
      if(item && typeof item._pauseVideo === 'function'){
        item._pauseVideo();
      }
    }


    function initPanelCarousel(panel){
      var track = panel.querySelector('.tc-items');
      if(!track) return;

      var items = Array.from(track.querySelectorAll('.tc-item'));
      if(!items.length) return;

      items.forEach(attachVideoControls);

      var prev = panel.querySelector('.tc-arrow--prev');
      var next = panel.querySelector('.tc-arrow--next');

      var mqDesktop = window.matchMedia('(min-width: 990px)');
      var isDesktop = mqDesktop.matches;

      function initDesktopMode(){
        if(items.length < 3) return false;

        var animating = false;

        function updateCenter(){
          var cards = Array.from(track.querySelectorAll('.tc-item'));
          cards.forEach(function(card, i){
            var isActive = (i === 1);
            card.classList.toggle('is-active', isActive);
            if(!isActive) pauseItemVideo(card);
          });
        }

        function slide(direction){
          if(animating) return;
          animating = true;

          var cards = track.querySelectorAll('.tc-item');
          if(!cards.length){
            animating = false;
            return;
          }

          var firstCard = cards[0];
          var styles = getComputedStyle(track);
          var gap = parseInt(styles.gap || '40', 10);
          if(isNaN(gap)) gap = 40;
          var distance = firstCard.offsetWidth + gap;

          track.style.transition = 'transform 0.35s ease';
          track.style.transform  = 'translateX(' + (direction > 0 ? -distance : distance) + 'px)';

          setTimeout(function(){
            track.style.transition = 'none';
            track.style.transform  = 'translateX(0)';

            if(direction > 0){
              var first = track.firstElementChild;
              if(first && first.classList.contains('tc-item')){
                track.appendChild(first);
              }
            } else {
              var last = track.lastElementChild;
              if(last && last.classList.contains('tc-item')){
                track.insertBefore(last, track.firstElementChild);
              }
            }

            Array.from(track.querySelectorAll('.tc-item')).forEach(attachVideoControls);
            updateCenter();

            setTimeout(function(){
              track.style.transition = 'transform 0.35s ease';
              animating = false;
            }, 20);

          }, 350);
        }

        if(prev){
          prev.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            slide(-1);
          });
        }
        if(next){
          next.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            slide(1);
          });
        }

        track.addEventListener('click', function(e){
          if(
            e.target.closest('.tc-arrow') ||
            e.target.closest('.tc-item__controls') ||
            e.target.closest('.tc-item__btn')
          ) return;

          var card = e.target.closest('.tc-item');
          if(!card) return;

          var cards = Array.from(track.querySelectorAll('.tc-item'));
          var idx   = cards.indexOf(card);

          if(idx === 0) slide(-1);
          if(idx === 2) slide(1);
        });

        updateCenter();
        return true;
      }

      function initSimpleMode(){
        var index = 0;

        function scrollToIndex(newIndex){
          if(!items.length) return;
          if(newIndex < 0) newIndex = items.length - 1;
          if(newIndex >= items.length) newIndex = 0;
          index = newIndex;

          var cardWidth = track.clientWidth;
          var target    = cardWidth * index;

          if(typeof track.scrollTo === 'function'){
            track.scrollTo({ left: target, behavior: 'smooth' });
          } else {
            track.scrollLeft = target;
          }

          items.forEach(function(item, i){
            var isActive = (i === index);
            if(!isActive){
              pauseItemVideo(item);
            }
            item.classList.toggle('is-active', isActive);
          });
        }

        if(prev){
          prev.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            scrollToIndex(index - 1);
          });
        }
        if(next){
          next.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            scrollToIndex(index + 1);
          });
        }

        var scrollTimeout = null;
        track.addEventListener('scroll', function(){
          if(scrollTimeout) window.clearTimeout(scrollTimeout);
          scrollTimeout = window.setTimeout(function(){
            var cardWidth = track.clientWidth || 1;
            var newIndex  = Math.round(track.scrollLeft / cardWidth);
            if(newIndex < 0) newIndex = 0;
            if(newIndex >= items.length) newIndex = items.length - 1;
            index = newIndex;
            items.forEach(function(item, i){
              var isActive = (i === index);
              if(!isActive){
                pauseItemVideo(item);
              }
              item.classList.toggle('is-active', isActive);
            });
          }, 80);
        }, { passive:true });

        scrollToIndex(0);
      }

      if(isDesktop && items.length >= 3){
        initDesktopMode();
      } else {
        initSimpleMode();
      }
    }

    panels.forEach(function(panel){
      initPanelCarousel(panel);
    });

  })();
</script>

{% schema %}
{
  "name": "Tabs carousel",
  "tag": "section",
  "class": "section-tabs-carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título de la sección",
      "default": "Decorating tips from VL"
    },
    {
      "type": "select",
      "id": "section_bg_type",
      "label": "Fondo de la sección",
      "options": [
        { "value": "color", "label": "Color" },
        { "value": "image", "label": "Imagen" }
      ],
      "default": "color"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Color de fondo de la sección",
      "default": "#000000"
    },
    {
      "type": "image_picker",
      "id": "section_bg_image",
      "label": "Imagen de fondo de la sección"
    },
    {
      "type": "header",
      "content": "Tabs"
    },
    {
      "type": "color",
      "id": "tab_bg",
      "label": "Fondo del tab",
      "default": "#f2f2f2"
    },
    {
      "type": "color",
      "id": "tab_bg_hover",
      "label": "Fondo del tab (hover/activo)",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "tab_text_color",
      "label": "Color de texto del tab (opcional, deja vacío para auto)"
    },
    {
      "type": "color",
      "id": "tab_text_hover_color",
      "label": "Color de texto (hover/activo) del tab (opcional, deja vacío para auto)"
    },
    {
      "type": "range",
      "id": "tab_font_size",
      "min": 12,
      "max": 28,
      "step": 1,
      "unit": "px",
      "label": "Tamaño de letra de los tabs",
      "default": 16
    },
    {
      "type": "header",
      "content": "Cards – Tamaño letra, Fondo y overlay"
    },
    {
      "type": "range",
      "id": "item_title_size",
      "min": 16,
      "max": 46,
      "step": 2,
      "unit": "px",
      "label": "Tamaño de letra titulo cards",
      "default": 46
    },
    {
      "type": "range",
      "id": "item_desc_size",
      "min": 12,
      "max": 28,
      "step": 2,
      "unit": "px",
      "label": "Tamaño de letra texto cards",
      "default": 12
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Color de fondo de respaldo de las cards",
      "default": "#15131a"
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay (color)",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Overlay (opacidad)",
      "min": 0,
      "max": 90,
      "step": 5,
      "unit": "%",
      "default": 45
    },
    {
      "type": "range",
      "id": "min_height_desktop",
      "min": 300,
      "max": 800,
      "step": 10,
      "unit": "px",
      "label": "Alto mínimo de las cards (desktop)",
      "default": 520
    },
    {
      "type": "range",
      "id": "min_height_mobile",
      "min": 200,
      "max": 700,
      "step": 10,
      "unit": "px",
      "label": "Alto mínimo de las cards (mobile)",
      "default": 420
    },
    {
      "type": "header",
      "content": "Contenedor de texto"
    },
    {
      "type": "select",
      "id": "content_align",
      "label": "Alineación horizontal del contenido",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ],
      "default": "left"
    },
    {
      "type": "select",
      "id": "content_valign",
      "label": "Alineación vertical del contenido",
      "options": [
        { "value": "top", "label": "Arriba" },
        { "value": "center", "label": "Centro" },
        { "value": "bottom", "label": "Abajo" }
      ],
      "default": "center"
    },
    {
      "type": "checkbox",
      "id": "content_bg_enable",
      "label": "Usar color de fondo bajo el texto",
      "default": false
    },
    {
      "type": "color",
      "id": "content_bg",
      "label": "Color fondo contenido",
      "default": "#111111"
    },
    {
      "type": "range",
      "id": "content_bg_radius",
      "min": 0,
      "max": 28,
      "step": 1,
      "unit": "px",
      "label": "Borde redondeado contenido",
      "default": 0
    },
    {
      "type": "range",
      "id": "content_max_width",
      "min": 200,
      "max": 900,
      "step": 10,
      "unit": "px",
      "label": "Ancho máximo contenido",
      "default": 440
    },
    {
      "type": "header",
      "content": "Padding sección"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 40
    },
    {
      "type": "header",
      "content": "Estilos Botón items"
    },
    {
      "type": "color",
      "id": "btn_bg",
      "label": "Botón: fondo",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "btn_text",
      "label": "Botón: texto",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "btn_bg_hover",
      "label": "Botón: fondo (hover)",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "btn_text_hover",
      "label": "Botón: texto (hover)",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 300,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 52
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab / Diapositiva",
      "settings": [
        { "type": "text", "id": "tab_label", "label": "Texto del tab", "default": "Christmas" },
        { "type": "checkbox", "id": "auto_contrast", "label": "Auto-contraste del texto en el tab", "default": true },

        { "type": "select", "id": "bg_type", "label": "Fondo del item 1", "options": [
          { "value": "image", "label": "Imagen" },
          { "value": "color", "label": "Solo color (sin imagen)" }
        ], "default": "image" },

        {
          "type": "select",
          "id": "media_type",
          "label": "Tipo de medio item 1",
          "default": "image",
          "options": [
            { "value": "image", "label": "Imagen" },
            { "value": "video", "label": "Video" }
          ]
        },
        { "type": "image_picker", "id": "bg_image", "label": "Imagen de fondo item 1" },
        { "type": "text", "id": "bg_image_alt", "label": "Alt text imagen item 1", "default": "Background" },

        {
          "type": "video",
          "id": "video_file",
          "label": "Video subido item 1 (MP4, mov)",
          "info": "Se prioriza sobre externo/URL."
        },
        { "type": "url", "id": "external_video", "label": "Video externo item 1 (YouTube/Vimeo)" },
        { "type": "url", "id": "video_mp4_url", "label": "URL MP4 directa item 1 (opcional)" },

        { "type": "select", "id": "bg_position", "label": "Posición imagen item 1 (no aplica a video)", "options": [
          { "value": "center center", "label": "Centro" },
          { "value": "top center", "label": "Arriba" },
          { "value": "bottom center", "label": "Abajo" }
        ], "default": "center center" },

        { "type": "header", "content": "Item 1 (central)" },
        { "type": "richtext", "id": "title", "label": "Título item 1", "default": "<p>How to choose the perfect light intensity</p>" },
        { "type": "richtext", "id": "rich_text", "label": "Descripción item 1", "default": "<p>Texto descriptivo de la diapositiva.</p>" },
        { "type": "text", "id": "button_label", "label": "Texto del botón item 1", "default": "Read more" },
        { "type": "url", "id": "button_link", "label": "Enlace del botón item 1" },
        { "type": "color", "id": "item_txt_color", "label": "Color texto item 1", "default": "#ffffff" },

        { "type": "header", "content": "Item 2" },
        { "type": "select", "id": "item_2_media_type", "label": "Tipo de medio item 2", "default": "image",
          "options": [ { "value": "image", "label": "Imagen" }, { "value": "video", "label": "Video" } ]
        },
        { "type": "image_picker", "id": "item_2_image", "label": "Imagen de fondo item 2" },
        { "type": "text", "id": "item_2_image_alt", "label": "Alt text imagen item 2", "default": "Card imageCard image" },
        { "type": "video", "id": "item_2_video_file", "label": "Video subido item 2" },
        { "type": "url", "id": "item_2_external_video", "label": "Video externo item 2" },
        { "type": "url", "id": "item_2_video_mp4_url", "label": "URL MP4 directa item 2" },
        { "type": "richtext", "id": "item_2_title", "label": "Título item 2" },
        { "type": "richtext", "id": "item_2_rich_text", "label": "Descripción item 2" },
        { "type": "text", "id": "item_2_button_label", "label": "Texto del botón item 2" },
        { "type": "url", "id": "item_2_button_link", "label": "Enlace del botón item 2" },

        { "type": "header", "content": "Item 3" },
        { "type": "select", "id": "item_3_media_type", "label": "Tipo de medio item 3", "default": "image",
          "options": [ { "value": "image", "label": "Imagen" }, { "value": "video", "label": "Video" } ]
        },
        { "type": "image_picker", "id": "item_3_image", "label": "Imagen de fondo item 3" },
        { "type": "text", "id": "item_3_image_alt", "label": "Alt text imagen item 3", "default": "Card image" },
        { "type": "video", "id": "item_3_video_file", "label": "Video subido item 3" },
        { "type": "url", "id": "item_3_external_video", "label": "Video externo item 3" },
        { "type": "url", "id": "item_3_video_mp4_url", "label": "URL MP4 directa item 3" },
        { "type": "richtext", "id": "item_3_title", "label": "Título item 3" },
        { "type": "richtext", "id": "item_3_rich_text", "label": "Descripción item 3" },
        { "type": "text", "id": "item_3_button_label", "label": "Texto del botón item 3" },
        { "type": "url", "id": "item_3_button_link", "label": "Enlace del botón item 3" },

        { "type": "header", "content": "Item 4" },
        { "type": "select", "id": "item_4_media_type", "label": "Tipo de medio item 4", "default": "image",
          "options": [ { "value": "image", "label": "Imagen" }, { "value": "video", "label": "Video" } ]
        },
        { "type": "image_picker", "id": "item_4_image", "label": "Imagen de fondo item 4" },
        { "type": "text", "id": "item_4_image_alt", "label": "Alt text imagen item 4", "default": "Card image" },
        { "type": "video", "id": "item_4_video_file", "label": "Video subido item 4" },
        { "type": "url", "id": "item_4_external_video", "label": "Video externo item 4" },
        { "type": "url", "id": "item_4_video_mp4_url", "label": "URL MP4 directa item 4" },
        { "type": "richtext", "id": "item_4_title", "label": "Título item 4" },
        { "type": "richtext", "id": "item_4_rich_text", "label": "Descripción item 4" },
        { "type": "text", "id": "item_4_button_label", "label": "Texto del botón item 4" },
        { "type": "url", "id": "item_4_button_link", "label": "Enlace del botón item 4" },

        { "type": "header", "content": "Item 5" },
        { "type": "select", "id": "item_5_media_type", "label": "Tipo de medio item 5", "default": "image",
          "options": [ { "value": "image", "label": "Imagen" }, { "value": "video", "label": "Video" } ]
        },
        { "type": "image_picker", "id": "item_5_image", "label": "Imagen de fondo item 5" },
        { "type": "text", "id": "item_5_image_alt", "label": "Alt text imagen item 5", "default": "Card image" },
        { "type": "video", "id": "item_5_video_file", "label": "Video subido item 5" },
        { "type": "url", "id": "item_5_external_video", "label": "Video externo item 5" },
        { "type": "url", "id": "item_5_video_mp4_url", "label": "URL MP4 directa item 5" },
        { "type": "richtext", "id": "item_5_title", "label": "Título item 5" },
        { "type": "richtext", "id": "item_5_rich_text", "label": "Descripción item 5" },
        { "type": "text", "id": "item_5_button_label", "label": "Texto del botón item 5" },
        { "type": "url", "id": "item_5_button_link", "label": "Enlace del botón item 5" },

        { "type": "header", "content": "Item 6" },
        { "type": "select", "id": "item_6_media_type", "label": "Tipo de medio item 6", "default": "image",
          "options": [ { "value": "image", "label": "Imagen" }, { "value": "video", "label": "Video" } ]
        },
        { "type": "image_picker", "id": "item_6_image", "label": "Imagen de fondo item 6" },
        { "type": "text", "id": "item_6_image_alt", "label": "Alt text imagen item 6", "default": "Card image" },
        { "type": "video", "id": "item_6_video_file", "label": "Video subido item 6" },
        { "type": "url", "id": "item_6_external_video", "label": "Video externo item 6" },
        { "type": "url", "id": "item_6_video_mp4_url", "label": "URL MP4 directa item 6" },
        { "type": "richtext", "id": "item_6_title", "label": "Título item 6" },
        { "type": "richtext", "id": "item_6_rich_text", "label": "Descripción item 6" },
        { "type": "text", "id": "item_6_button_label", "label": "Texto del botón item 6" },
        { "type": "url", "id": "item_6_button_link", "label": "Enlace del botón item 6" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Custom Tabs Carousel",
      "category": "Custom"
    }
  ]
}
{% endschema %}
