{% comment %}
 - Custom Mega Menu
- Tabs: Season | Category | Brand | Collection
- Season/Brand/Collection uses a "horizontal accordion" design.
- Category uses a special design: circles on the left + hero on the right.
{% endcomment %}


<nav class="header__inline-menu">
  <ul class="list-menu list-menu--inline" role="list">
    {%- for link in section.settings.menu.links -%}
      <li>
        {%- if link.links != blank -%}
          <header-menu>
            <details id="Details-HeaderMenu-{{ forloop.index }}" class="mega-menu">
              <summary
                id="HeaderMenu-{{ link.handle }}"
                class="header__menu-item list-menu__item link focus-inset"
              >
                <span{% if link.child_active %} class="header__active-menu-item"{% endif %}>
                  {{- link.title | escape -}}
                </span>
                {{- 'icon-caret.svg' | inline_asset_content -}}
              </summary>

              <div
                id="MegaMenu-Content-{{ forloop.index }}"
                class="mega-menu__content color-{{ section.settings.menu_color_scheme }} gradient motion-reduce global-settings-popup"
                tabindex="-1"
              >
                <div class="optionB__container">

                  {%- comment -%} ========= TABS FISRT LEVEL  {%- endcomment -%}
                  <nav class="optionB__tabs" aria-label="{{ link.title | escape }}">
                    <ul class="optionB__tabs-list" role="list">
                      {%- for childlink in link.links -%}
                        {%- liquid
                          assign cfg = nil
                          assign child_title_down = childlink.title | strip | downcase

                          for b in section.blocks
                            if b.type == 'mega_config'
                              assign b_down = b.settings.trigger_label | strip | downcase
                              if b_down == child_title_down
                                assign cfg = b
                                break
                              endif
                            endif
                          endfor

                          assign panel_id = 'mm-panel-' | append: forloop.parentloop.index | append: '-' | append: forloop.index

                          assign tab_url = childlink.url
                          if child_title_down == 'season' and tab_url contains '/collections/'
                            assign tab_url = tab_url | replace: '/collections/', '/pages/'
                          endif
                        -%}

                        <li class="optionB__tabs-item">
                          <a
                            href="{{ tab_url }}"
                            class="optionB__tabs-link header__menu-item list-menu__item link link--text focus-inset"
                            data-panel="{{ panel_id }}"
                            data-has-panel="{% if cfg %}true{% else %}false{% endif %}"
                          >
                            By {{ childlink.title }}
                          </a>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </nav>

                  {%- comment -%} ========= PANELS ========= {%- endcomment -%}
                  <div
                    class="optionB__panels{% if section.settings.background_image != blank %} has-bg{% endif %}"
                    {% if section.settings.background_image != blank %}
                      style="background-image: url('{{ section.settings.background_image | image_url: width: 2000 }}');"
                    {% endif %}
                  >
                    {%- assign rendered_any_panel = false -%}

                    {%- for childlink in link.links -%}
                      {%- liquid
                        assign cfg = nil
                        assign child_title = childlink.title | strip
                        assign child_title_down = child_title | downcase

                        for b in section.blocks
                          if b.type == 'mega_config'
                            assign b_down = b.settings.trigger_label | strip | downcase
                            if b_down == child_title_down
                              assign cfg = b
                              break
                            endif
                          endif
                        endfor

                        assign panel_id = 'mm-panel-' | append: forloop.parentloop.index | append: '-' | append: forloop.index
                      -%}

                      {%- if cfg -%}
                        {%- assign rendered_any_panel = true -%}

                        {%- assign panel_classes = 'optionB__panel page-width ' -%}
                        {%- if child_title_down == 'category' -%}
                          {%- assign panel_classes = panel_classes | append: ' optionB__panel--category' -%}
                        {%- else -%}
                          {%- assign panel_classes = panel_classes | append: ' optionB__panel--expanding' -%}
                        {%- endif -%}

                        <div
                          class="{{ panel_classes }}"
                          id="{{ panel_id }}"
                          role="region"
                          aria-label="{{ childlink.title | escape }}"
                        >

                          {%- comment -%}
                            CATEGORY MOOD
                          {%- endcomment -%}
                          {%- if child_title_down == 'category' -%}
                            {%- assign menu_source = nil -%}
                            {%- if cfg.settings.side_menu != blank and linklists[cfg.settings.side_menu] -%}
                              {%- assign menu_source = linklists[cfg.settings.side_menu].links -%}
                            {%- elsif childlink.links != blank -%}
                              {%- assign menu_source = childlink.links -%}
                            {%- endif -%}

                            <span class="shop-by"> Shop by {{ child_title_down }}</span>
                            <div class="megamenu-cat">
                              <div class="megamenu-cat__thumbs">
                                {%- if menu_source -%}
                                  {%- for item in menu_source -%}
                                    {%- liquid
                                      assign hero_id = panel_id | append: '-hero-' | append: forloop.index
                                      assign col_handle = item.url | split: '/collections/' | last | split: '/' | first
                                      assign col = collections[col_handle]
                                    -%}
                                    <a href="{{  item.url }}">
                                      <button
                                        type="button"
                                        class="megamenu-cat__thumb{% if forloop.first %} is-active{% endif %}"
                                        data-hero="{{ hero_id }}"
                                      >
                                        <span class="megamenu-cat__thumb-image">
                                          {%- if col and col.image -%}
                                            {{ col.image | image_url: width: 320 | image_tag:
                                              loading: 'lazy',
                                              widths: '160,240,320',
                                              sizes: '120px',
                                              alt: col.title | escape
                                            }}
                                          {%- else -%}
                                            <span class="megamenu-cat__thumb-placeholder" aria-hidden="true"></span>
                                          {%- endif -%}
                                        </span>
                                        <span class="megamenu-cat__thumb-label">
                                          {{ item.title | upcase }}
                                        </span>
                                      </button>
                                    </a>
                                  {%- endfor -%}
                                {%- endif -%}
                              </div>

                              <div class="megamenu-cat__hero-wrap">
                                {%- if menu_source -%}
                                  {%- for item in menu_source -%}
                                    {%- liquid
                                      assign hero_id = panel_id | append: '-hero-' | append: forloop.index
                                      assign col_handle = item.url | split: '/collections/' | last | split: '/' | first
                                      assign col = collections[col_handle]
                                    -%}
                                    {%- if col -%}
                                      <a
                                        id="{{ hero_id }}"
                                        href="{{ col.url }}"
                                        class="megamenu-cat__hero{% if forloop.first %} is-active{% endif %}"
                                      >
                                        <div class="megamenu-cat__hero-image">
                                          {%- if col.image -%}
                                            {{ col.image | image_url: width: 1200 | image_tag:
                                              loading: 'lazy',
                                              widths: '600,900,1200',
                                              sizes: '(min-width: 1200px) 60vw, 100vw',
                                              alt: col.title | escape
                                            }}
                                          {%- endif -%}
                                        </div>
                                        <div class="megamenu-cat__hero-overlay">
                                          <span class="megamenu-cat__hero-title head-card-title">
                                            <span>{{ col.title }}</span> {{- 'icon-caret.svg' | inline_asset_content -}}
                                          </span>
                                        </div>
                                      </a>
                                    {%- endif -%}
                                  {%- endfor -%}
                                {%- endif -%}
                              </div>
                            </div>

                          {%- else -%}

                            {%- comment -%}
                              MODE DEFAULT (Season / Collection)
                            {%- endcomment -%}
                            <div class="megamenu-pb__grid">
                              <nav class="megamenu-pb__nav" aria-label="{{ cfg.settings.side_menu_label | default: childlink.title }}">
                                {%- assign side_links = nil -%}
                                {%- if cfg.settings.side_menu != blank and linklists[cfg.settings.side_menu] -%}
                                  {%- assign side_links = linklists[cfg.settings.side_menu].links -%}
                                {%- elsif childlink.links != blank -%}
                                  {%- assign side_links = childlink.links -%}
                                {%- endif -%}

                                <ul class="megamenu-pb__list" role="list">
                                  <span class="shop-by"> Shop by {{ childlink.title }} </span>

                                  {%- if side_links -%}
                                    {%- for item in side_links -%}
                                      {%- liquid
                                        assign fixed_url = item.url
                                        if child_title_down == 'season' and fixed_url contains '/collections/'
                                          assign fixed_url = fixed_url | replace: '/collections/', '/pages/'
                                        endif
                                      -%}
                                      <li class="megamenu-pb__item">
                                        <a
                                          class="megamenu-pb__link header__menu-item list-menu__item link link--text focus-inset{% if forloop.first %} is-active{% endif %}"
                                          href="{{ fixed_url }}"
                                          data-card-index="{{ forloop.index0 }}"
                                        >
                                          {{ item.title }}
                                        </a>
                                      </li>
                                    {%- endfor -%}
                                  {%- else -%}
                                    {%- liquid
                                      assign fixed_url = childlink.url
                                      if child_title_down == 'season' and fixed_url contains '/collections/'
                                        assign fixed_url = fixed_url | replace: '/collections/', '/pages/'
                                      endif
                                    -%}
                                    <li class="megamenu-pb__item">
                                      <a class="megamenu-pb__link header__menu-item list-menu__item link link--text focus-inset" href="{{ fixed_url }}">
                                        {{ childlink.title }}
                                      </a>
                                    </li>
                                  {%- endif -%}
                                </ul>
                              </nav>

                              <div class="megamenu-pb__featured megamenu-pb__featured--expanding">
                                {%- if side_links -%}
                                  {%- for item in side_links -%}
                                    {%- liquid
                                      assign card_id = panel_id | append: '-card-' | append: forloop.index

                                      assign col_handle = item.url | split: '/collections/' | last | split: '/' | first
                                      assign col = collections[col_handle]
                                      if col == nil and item.type == 'collection_link'
                                        assign col = item.object
                                      endif
                                    -%}

                                    {%- if col -%}
                                      {%- liquid
                                        assign fixed_url = col.url
                                        if child_title_down == 'season' and fixed_url contains '/collections/'
                                          assign fixed_url = fixed_url | replace: '/collections/', '/pages/'
                                        endif
                                      -%}

                                      <a
                                        id="{{ card_id }}"
                                        href="{{ fixed_url }}"
                                        class="megamenu-pb__card{% if forloop.first %} is-expanded is-active{% endif %}"
                                        data-card-index="{{ forloop.index0 }}"
                                      >
                                        <div class="megamenu-pb__image-wrap">
                                          {%- if col.image -%}
                                            {{ col.image | image_url: width: 920 | image_tag:
                                              loading: 'lazy',
                                              sizes: '(min-width: 1200px) 26vw, 70vw',
                                              widths: '480,720,920',
                                              alt: col.title | escape
                                            }}
                                          {%- endif -%}
                                        </div>
                                        <span class="megamenu-pb__title head-card-title">
                                          <span>{{ col.title }}</span> {{- 'icon-caret.svg' | inline_asset_content -}}
                                        </span>
                                      </a>
                                    {%- endif -%}
                                  {%- endfor -%}
                                {%- endif -%}
                              </div>
                            </div>

                          {%- endif -%}
                        </div>
                      {%- endif -%}
                    {%- endfor -%}

                    {%- unless rendered_any_panel -%}
                      <ul class="mega-menu__list{% if link.levels == 1 %} mega-menu__list--condensed{% endif %}" role="list">
                        {%- for childlink in link.links -%}
                          <li>
                            <a href="{{ childlink.url }}" class="mega-menu__link mega-menu__link--level-2 link">{{ childlink.title }}</a>
                            {%- if childlink.links != blank -%}
                              <ul class="list-unstyled" role="list">
                                {%- for gl in childlink.links -%}
                                  <li><a href="{{ gl.url }}" class="mega-menu__link link menu-drawer__menu-item link link--text list-menu__item">{{ gl.title }}</a></li>
                                {%- endfor -%}
                              </ul>
                            {%- endif -%}
                          </li>
                        {%- endfor -%}
                      </ul>
                    {%- endunless -%}

                  </div>
                </div>
              </div>
            </details>
          </header-menu>

        {%- else -%}
          <a
            id="HeaderMenu-{{ link.handle }}"
            href="{{ link.url }}"
            class="header__menu-item list-menu__item link link--text focus-inset"
            {% if link.current %}aria-current="page"{% endif %}
          >
            <span{% if link.current %} class="header__active-menu-item"{% endif %}>
              {{- link.title | escape -}}
            </span>
          </a>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</nav>


<div id="mobile-mega-templates" hidden>
  {% for b in section.blocks %}
    {% if b.type == 'mega_config' %}
      {% assign trigger = b.settings.trigger_label | strip %}
      {% assign trigger_down = trigger | downcase %}
      <template data-trigger="{{ trigger | escape }}">
        <div class="mobile-mega">
          <div class="mobile-mega__list">

            {% if b.settings.side_menu != blank and linklists[b.settings.side_menu] %}
              <ul>
                {% for l in linklists[b.settings.side_menu].links %}
                  {%- liquid
                    assign fixed_url = l.url
                    if trigger_down == 'season' and fixed_url contains '/collections/'
                      assign fixed_url = fixed_url | replace: '/collections/', '/pages/'
                    endif
                  -%}
                  <li>
                    <a
                      href="{{ fixed_url }}"
                      class="menu-drawer__menu-item link link--text list-menu__item focus-inset"
                    >
                      {{ l.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <ul></ul>
            {% endif %}

          </div>
        </div>
      </template>
    {% endif %}
  {% endfor %}
</div>

{{ 'custom-mega-menu.css' | asset_url | stylesheet_tag }}

<script src="{{ 'custom-mega-menu.js' | asset_url }}" defer="defer"></script>

